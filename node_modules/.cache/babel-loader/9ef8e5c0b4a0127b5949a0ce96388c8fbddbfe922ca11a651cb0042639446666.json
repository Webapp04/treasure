{"ast":null,"code":"import _regeneratorRuntime from\"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";import _createForOfIteratorHelper from\"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper.js\";import _asyncToGenerator from\"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import AirdropApi from\"api/AirdropApi\";import useHandleToastAlert from\"hooks/alert/useHandleToastAlert\";import useHandleCustomer from\"hooks/customer/useHandleCustomer\";import{useDispatch,useSelector}from\"react-redux\";import ACTIONS from\"redux/action\";import{selectAvaxBalance}from\"redux/slice/balanceSlice\";import{selectUser}from\"redux/slice/userSlice\";import useGetZoneCommission from\"./useGetZoneCommission\";import useReloadNFTItemBalance from\"./useReloadNFTItemBalance\";import{useContractNFKeyWithSigner}from\"hooks/blockchain/useHandleContracts\";export default function useBatchMint(){var user=useSelector(selectUser);var avaxBalance=useSelector(selectAvaxBalance);var dispatch=useDispatch();var handleCustomer=useHandleCustomer();var handleToastAlert=useHandleToastAlert();var handleGetZoneCommission=useGetZoneCommission();var handleReloadNFTItemBalance=useReloadNFTItemBalance();var handleContractNFKeyWithSigner=useContractNFKeyWithSigner();var batchMint=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee2(zones,amounts){var commission,i,merkle_data,merkle_proof,merkle_wl,contractNFKeyWithSigner;return _regeneratorRuntime().wrap(function _callee2$(_context2){while(1)switch(_context2.prev=_context2.next){case 0:commission=0;i=0;case 2:if(!(i<zones.length)){_context2.next=12;break;}_context2.t0=commission;_context2.next=6;return handleGetZoneCommission.getZoneCommission(user===null||user===void 0?void 0:user.wallet_id,zones[i]);case 6:_context2.t1=_context2.sent;_context2.t2=amounts[i];commission=_context2.t0+=_context2.t1*_context2.t2;case 9:i++;_context2.next=2;break;case 12:_context2.next=14;return handleCustomer.getMerkleTree(user===null||user===void 0?void 0:user.wallet_id);case 14:merkle_data=_context2.sent;merkle_proof=merkle_data[0].proof;merkle_wl={whitelistAddress:merkle_data[0].whitelistAddress,level:merkle_data[0].level,zone1:merkle_data[0].zone1,zone2:merkle_data[0].zone2,zone3:merkle_data[0].zone3,zone4:merkle_data[0].zone4};if(!(commission>avaxBalance*Math.pow(10,18))){_context2.next=21;break;}handleToastAlert.error(\"Insufficient balance\");new AirdropApi().logger({wallet_id:user===null||user===void 0?void 0:user.wallet_id,type:\"ERROR\",action:\"mint\",description:\"Insufficient balance\",error:JSON.stringify(\"Insufficient balance\")});return _context2.abrupt(\"return\");case 21:_context2.next=23;return handleContractNFKeyWithSigner;case 23:contractNFKeyWithSigner=_context2.sent;return _context2.abrupt(\"return\",contractNFKeyWithSigner.batchMint(user===null||user===void 0?void 0:user.wallet_id,zones,amounts,merkle_wl,merkle_proof,{value:commission.toString()}).then(/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee(tx){var _answer$logs;var answer,transactionLogList,_iterator,_step,transactionLog,tokenID;return _regeneratorRuntime().wrap(function _callee$(_context){while(1)switch(_context.prev=_context.next){case 0:new AirdropApi().logger({wallet_id:user===null||user===void 0?void 0:user.wallet_id,type:\"PENDING\",action:\"mint\",description:\"HomeMint batch token\",tx:JSON.stringify(tx)});_context.next=3;return tx.wait();case 3:answer=_context.sent;ACTIONS.SET_TRANSANCTION_HASH(dispatch,tx===null||tx===void 0?void 0:tx.hash);transactionLogList=answer===null||answer===void 0?void 0:(_answer$logs=answer.logs)===null||_answer$logs===void 0?void 0:_answer$logs.filter(function(log){return(log===null||log===void 0?void 0:log.address)===process.env.REACT_APP_NFKEY_ADDRESS;});_iterator=_createForOfIteratorHelper(transactionLogList);_context.prev=7;_iterator.s();case 9:if((_step=_iterator.n()).done){_context.next=17;break;}transactionLog=_step.value;tokenID=parseInt(transactionLog===null||transactionLog===void 0?void 0:transactionLog.topics[3],16);// FIXME: should remove this\nif(!(+tokenID>0&&+tokenID<10000)){_context.next=15;break;}_context.next=15;return handleReloadNFTItemBalance.reloadNFTItemBalance(process.env.REACT_APP_NFKEY_ADDRESS,tokenID);case 15:_context.next=9;break;case 17:_context.next=22;break;case 19:_context.prev=19;_context.t0=_context[\"catch\"](7);_iterator.e(_context.t0);case 22:_context.prev=22;_iterator.f();return _context.finish(22);case 25:return _context.abrupt(\"return\",transactionLogList);case 26:case\"end\":return _context.stop();}},_callee,null,[[7,19,22,25]]);}));return function(_x3){return _ref2.apply(this,arguments);};}()).catch(function(err){new AirdropApi().logger({wallet_id:user===null||user===void 0?void 0:user.wallet_id,type:\"ERROR\",action:\"mint\",description:\"HomeMint unique token\",error:JSON.stringify(err)});}));case 25:case\"end\":return _context2.stop();}},_callee2);}));return function batchMint(_x,_x2){return _ref.apply(this,arguments);};}();return{batchMint:batchMint};}","map":{"version":3,"names":["AirdropApi","useHandleToastAlert","useHandleCustomer","useDispatch","useSelector","ACTIONS","selectAvaxBalance","selectUser","useGetZoneCommission","useReloadNFTItemBalance","useContractNFKeyWithSigner","useBatchMint","user","avaxBalance","dispatch","handleCustomer","handleToastAlert","handleGetZoneCommission","handleReloadNFTItemBalance","handleContractNFKeyWithSigner","batchMint","_ref","_asyncToGenerator","_regeneratorRuntime","mark","_callee2","zones","amounts","commission","i","merkle_data","merkle_proof","merkle_wl","contractNFKeyWithSigner","wrap","_callee2$","_context2","prev","next","length","t0","getZoneCommission","wallet_id","t1","sent","t2","getMerkleTree","proof","whitelistAddress","level","zone1","zone2","zone3","zone4","Math","pow","error","logger","type","action","description","JSON","stringify","abrupt","value","toString","then","_ref2","_callee","tx","_answer$logs","answer","transactionLogList","_iterator","_step","transactionLog","tokenID","_callee$","_context","wait","SET_TRANSANCTION_HASH","hash","logs","filter","log","address","process","env","REACT_APP_NFKEY_ADDRESS","_createForOfIteratorHelper","s","n","done","parseInt","topics","reloadNFTItemBalance","e","f","finish","stop","_x3","apply","arguments","catch","err","_x","_x2"],"sources":["/Users/apple/Documents/treasure/src/hooks/nft/useBatchMint.js"],"sourcesContent":["import AirdropApi from \"api/AirdropApi\";\nimport useHandleToastAlert from \"hooks/alert/useHandleToastAlert\";\nimport useHandleCustomer from \"hooks/customer/useHandleCustomer\";\nimport { useDispatch, useSelector } from \"react-redux\";\nimport ACTIONS from \"redux/action\";\nimport { selectAvaxBalance } from \"redux/slice/balanceSlice\";\nimport { selectUser } from \"redux/slice/userSlice\";\nimport useGetZoneCommission from \"./useGetZoneCommission\";\nimport useReloadNFTItemBalance from \"./useReloadNFTItemBalance\";\nimport { useContractNFKeyWithSigner } from \"hooks/blockchain/useHandleContracts\";\n\nexport default function useBatchMint() {\n  const user = useSelector(selectUser);\n  const avaxBalance = useSelector(selectAvaxBalance);\n  const dispatch = useDispatch();\n  const handleCustomer = useHandleCustomer();\n  const handleToastAlert = useHandleToastAlert();\n  const handleGetZoneCommission = useGetZoneCommission();\n  const handleReloadNFTItemBalance = useReloadNFTItemBalance();\n  const handleContractNFKeyWithSigner = useContractNFKeyWithSigner();\n\n  const batchMint = async (zones, amounts) => {\n    let commission = 0;\n    for (let i = 0; i < zones.length; i++) {\n      commission +=\n        (await handleGetZoneCommission.getZoneCommission(\n          user?.wallet_id,\n          zones[i]\n        )) * amounts[i];\n    }\n    const merkle_data = await handleCustomer.getMerkleTree(user?.wallet_id);\n    const merkle_proof = merkle_data[0].proof;\n    const merkle_wl = {\n      whitelistAddress: merkle_data[0].whitelistAddress,\n      level: merkle_data[0].level,\n      zone1: merkle_data[0].zone1,\n      zone2: merkle_data[0].zone2,\n      zone3: merkle_data[0].zone3,\n      zone4: merkle_data[0].zone4,\n    };\n    if (commission > avaxBalance * 10 ** 18) {\n      handleToastAlert.error(\"Insufficient balance\");\n      new AirdropApi().logger({\n        wallet_id: user?.wallet_id,\n        type: \"ERROR\",\n        action: \"mint\",\n        description: \"Insufficient balance\",\n        error: JSON.stringify(\"Insufficient balance\"),\n      });\n      return;\n    }\n    const contractNFKeyWithSigner = await handleContractNFKeyWithSigner;\n    return contractNFKeyWithSigner\n      .batchMint(user?.wallet_id, zones, amounts, merkle_wl, merkle_proof, {\n        value: commission.toString(),\n      })\n      .then(async (tx) => {\n        new AirdropApi().logger({\n          wallet_id: user?.wallet_id,\n          type: \"PENDING\",\n          action: \"mint\",\n          description: \"HomeMint batch token\",\n          tx: JSON.stringify(tx),\n        });\n        const answer = await tx.wait();\n        ACTIONS.SET_TRANSANCTION_HASH(dispatch, tx?.hash);\n        const transactionLogList = answer?.logs?.filter(\n          (log) => log?.address === process.env.REACT_APP_NFKEY_ADDRESS\n        );\n        for (const transactionLog of transactionLogList) {\n          const tokenID = parseInt(transactionLog?.topics[3], 16);\n          // FIXME: should remove this\n          if (+tokenID > 0 && +tokenID < 10000)\n            await handleReloadNFTItemBalance.reloadNFTItemBalance(\n              process.env.REACT_APP_NFKEY_ADDRESS,\n              tokenID\n            );\n        }\n        return transactionLogList;\n      })\n      .catch((err) => {\n        new AirdropApi().logger({\n          wallet_id: user?.wallet_id,\n          type: \"ERROR\",\n          action: \"mint\",\n          description: \"HomeMint unique token\",\n          error: JSON.stringify(err),\n        });\n      });\n  };\n\n  return { batchMint };\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}