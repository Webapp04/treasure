{"ast":null,"code":"import _classCallCheck from \"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";\nimport _createClass from \"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/createClass.js\";\nimport { TimeCacheDuration } from '../constants.js';\nimport Denque from 'denque';\nexport var DeliveryRecordStatus;\n(function (DeliveryRecordStatus) {\n  /**\n   * we don't know (yet) if the message is valid\n   */\n  DeliveryRecordStatus[DeliveryRecordStatus[\"unknown\"] = 0] = \"unknown\";\n  /**\n   * we know the message is valid\n   */\n  DeliveryRecordStatus[DeliveryRecordStatus[\"valid\"] = 1] = \"valid\";\n  /**\n   * we know the message is invalid\n   */\n  DeliveryRecordStatus[DeliveryRecordStatus[\"invalid\"] = 2] = \"invalid\";\n  /**\n   * we were instructed by the validator to ignore the message\n   */\n  DeliveryRecordStatus[DeliveryRecordStatus[\"ignored\"] = 3] = \"ignored\";\n})(DeliveryRecordStatus || (DeliveryRecordStatus = {}));\n/**\n * Map of canonical message ID to DeliveryRecord\n *\n * Maintains an internal queue for efficient gc of old messages\n */\nexport var MessageDeliveries = /*#__PURE__*/function () {\n  function MessageDeliveries() {\n    _classCallCheck(this, MessageDeliveries);\n    this.records = new Map();\n    this.queue = new Denque();\n  }\n  _createClass(MessageDeliveries, [{\n    key: \"ensureRecord\",\n    value: function ensureRecord(msgIdStr) {\n      var drec = this.records.get(msgIdStr);\n      if (drec) {\n        return drec;\n      }\n      // record doesn't exist yet\n      // create record\n      drec = {\n        status: DeliveryRecordStatus.unknown,\n        firstSeen: Date.now(),\n        validated: 0,\n        peers: new Set()\n      };\n      this.records.set(msgIdStr, drec);\n      // and add msgId to the queue\n      var entry = {\n        msgId: msgIdStr,\n        expire: Date.now() + TimeCacheDuration\n      };\n      this.queue.push(entry);\n      return drec;\n    }\n  }, {\n    key: \"gc\",\n    value: function gc() {\n      var now = Date.now();\n      // queue is sorted by expiry time\n      // remove expired messages, remove from queue until first un-expired message found\n      var head = this.queue.peekFront();\n      while (head && head.expire < now) {\n        this.records.delete(head.msgId);\n        this.queue.shift();\n        head = this.queue.peekFront();\n      }\n    }\n  }, {\n    key: \"clear\",\n    value: function clear() {\n      this.records.clear();\n      this.queue.clear();\n    }\n  }]);\n  return MessageDeliveries;\n}();","map":{"version":3,"names":["TimeCacheDuration","Denque","DeliveryRecordStatus","MessageDeliveries","_classCallCheck","records","Map","queue","_createClass","key","value","ensureRecord","msgIdStr","drec","get","status","unknown","firstSeen","Date","now","validated","peers","Set","set","entry","msgId","expire","push","gc","head","peekFront","delete","shift","clear"],"sources":["../../../src/score/message-deliveries.ts"],"sourcesContent":[null],"mappings":";;AAAA,SAASA,iBAAiB,QAAQ,iBAAiB;AACnD,OAAOC,MAAM,MAAM,QAAQ;AAE3B,WAAYC,oBAiBX;AAjBD,WAAYA,oBAAoB;EAC9B;;;EAGAA,oBAAA,CAAAA,oBAAA,4BAAO;EACP;;;EAGAA,oBAAA,CAAAA,oBAAA,wBAAK;EACL;;;EAGAA,oBAAA,CAAAA,oBAAA,4BAAO;EACP;;;EAGAA,oBAAA,CAAAA,oBAAA,4BAAO;AACT,CAAC,EAjBWA,oBAAoB,KAApBA,oBAAoB;AA+BhC;;;;;AAKA,WAAaC,iBAAiB;EAI5B,SAAAA,kBAAA;IAAAC,eAAA,OAAAD,iBAAA;IACE,IAAI,CAACE,OAAO,GAAG,IAAIC,GAAG,EAAE;IACxB,IAAI,CAACC,KAAK,GAAG,IAAIN,MAAM,EAAE;EAC3B;EAACO,YAAA,CAAAL,iBAAA;IAAAM,GAAA;IAAAC,KAAA,EAED,SAAAC,aAAaC,QAAgB;MAC3B,IAAIC,IAAI,GAAG,IAAI,CAACR,OAAO,CAACS,GAAG,CAACF,QAAQ,CAAC;MACrC,IAAIC,IAAI,EAAE;QACR,OAAOA,IAAI;;MAGb;MACA;MACAA,IAAI,GAAG;QACLE,MAAM,EAAEb,oBAAoB,CAACc,OAAO;QACpCC,SAAS,EAAEC,IAAI,CAACC,GAAG,EAAE;QACrBC,SAAS,EAAE,CAAC;QACZC,KAAK,EAAE,IAAIC,GAAG;OACf;MACD,IAAI,CAACjB,OAAO,CAACkB,GAAG,CAACX,QAAQ,EAAEC,IAAI,CAAC;MAEhC;MACA,IAAMW,KAAK,GAAuB;QAChCC,KAAK,EAAEb,QAAQ;QACfc,MAAM,EAAER,IAAI,CAACC,GAAG,EAAE,GAAGnB;OACtB;MACD,IAAI,CAACO,KAAK,CAACoB,IAAI,CAACH,KAAK,CAAC;MAEtB,OAAOX,IAAI;IACb;EAAC;IAAAJ,GAAA;IAAAC,KAAA,EAED,SAAAkB,GAAA,EAAE;MACA,IAAMT,GAAG,GAAGD,IAAI,CAACC,GAAG,EAAE;MACtB;MACA;MACA,IAAIU,IAAI,GAAG,IAAI,CAACtB,KAAK,CAACuB,SAAS,EAAE;MACjC,OAAOD,IAAI,IAAIA,IAAI,CAACH,MAAM,GAAGP,GAAG,EAAE;QAChC,IAAI,CAACd,OAAO,CAAC0B,MAAM,CAACF,IAAI,CAACJ,KAAK,CAAC;QAC/B,IAAI,CAAClB,KAAK,CAACyB,KAAK,EAAE;QAClBH,IAAI,GAAG,IAAI,CAACtB,KAAK,CAACuB,SAAS,EAAE;;IAEjC;EAAC;IAAArB,GAAA;IAAAC,KAAA,EAED,SAAAuB,MAAA,EAAK;MACH,IAAI,CAAC5B,OAAO,CAAC4B,KAAK,EAAE;MACpB,IAAI,CAAC1B,KAAK,CAAC0B,KAAK,EAAE;IACpB;EAAC;EAAA,OAAA9B,iBAAA;AAAA"},"metadata":{},"sourceType":"module","externalDependencies":[]}