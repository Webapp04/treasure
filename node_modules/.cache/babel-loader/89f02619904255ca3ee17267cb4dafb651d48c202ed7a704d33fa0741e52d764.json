{"ast":null,"code":"import _regeneratorRuntime from\"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";import _asyncToGenerator from\"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import AuthApi from\"../../api/AuthApi\";import{localStorageRemove,localStorageSet}from\"../../utils/localStorage\";import useHandleCustomer from\"../customer/useHandleCustomer\";import{useNavigate}from\"react-router-dom\";import useWalletConnect from\"../blockchain/useWalletConnect\";import{useWeb3React}from\"@web3-react/core\";import ACTIONS from\"redux/action\";import{useDispatch}from\"react-redux\";import useGetSigner from\"hooks/blockchain/useHandleContracts\";export default function useHandleAuth(){var navigate=useNavigate();var dispatch=useDispatch();var handleAdmin=useHandleCustomer();var walletConnect=useWalletConnect();var _useWeb3React=useWeb3React(),library=_useWeb3React.library,deactivate=_useWeb3React.deactivate;var handleGetSigner=useGetSigner();var fetchLoginMetamask=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee(address,signature){return _regeneratorRuntime().wrap(function _callee$(_context){while(1)switch(_context.prev=_context.next){case 0:return _context.abrupt(\"return\",new AuthApi().loginMetamask({address:address,signature:signature}).then(function(res){return res!==null&&res!==void 0&&res.status?res===null||res===void 0?void 0:res.data:null;}));case 1:case\"end\":return _context.stop();}},_callee);}));return function fetchLoginMetamask(_x,_x2){return _ref.apply(this,arguments);};}();var login=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee2(){var signer,address,nonce,signature,loginData;return _regeneratorRuntime().wrap(function _callee2$(_context2){while(1)switch(_context2.prev=_context2.next){case 0:ACTIONS.SET_PENDING_LOADER(dispatch,true);_context2.next=3;return walletConnect.ethereumListener(logout);case 3:if(!library){_context2.next=7;break;}signer=library.getSigner();_context2.next=10;break;case 7:_context2.next=9;return handleGetSigner;case 9:signer=_context2.sent;case 10:_context2.next=12;return signer.getAddress();case 12:address=_context2.sent;if(address){_context2.next=15;break;}return _context2.abrupt(\"return\",ACTIONS.SET_PENDING_LOADER(dispatch,false));case 15:_context2.next=17;return handleAdmin.getNonce(address);case 17:nonce=_context2.sent;if(nonce){_context2.next=20;break;}return _context2.abrupt(\"return\",ACTIONS.SET_PENDING_LOADER(dispatch,false));case 20:_context2.next=22;return signer.signMessage(\"I am signing my one-time nonce: \".concat(nonce)).catch(function(){return null;});case 22:signature=_context2.sent;if(signature){_context2.next=25;break;}return _context2.abrupt(\"return\",ACTIONS.SET_PENDING_LOADER(dispatch,false));case 25:_context2.next=27;return fetchLoginMetamask(address,signature);case 27:loginData=_context2.sent;if(!(!(loginData!==null&&loginData!==void 0&&loginData.token)||!(loginData!==null&&loginData!==void 0&&loginData.user))){_context2.next=30;break;}return _context2.abrupt(\"return\",ACTIONS.SET_PENDING_LOADER(dispatch,false));case 30:ACTIONS.SET_USER(dispatch,loginData===null||loginData===void 0?void 0:loginData.use);localStorageSet(\"token\",loginData===null||loginData===void 0?void 0:loginData.token);ACTIONS.SET_PENDING_LOADER(dispatch,false);case 33:case\"end\":return _context2.stop();}},_callee2);}));return function login(){return _ref2.apply(this,arguments);};}();var logout=function logout(){localStorageRemove(\"token\");deactivate();localStorageRemove(\"isWalletConnected\");ACTIONS.LOGOUT(dispatch);navigate(\"/\");};return{login:login,logout:logout};}","map":{"version":3,"names":["AuthApi","localStorageRemove","localStorageSet","useHandleCustomer","useNavigate","useWalletConnect","useWeb3React","ACTIONS","useDispatch","useGetSigner","useHandleAuth","navigate","dispatch","handleAdmin","walletConnect","_useWeb3React","library","deactivate","handleGetSigner","fetchLoginMetamask","_ref","_asyncToGenerator","_regeneratorRuntime","mark","_callee","address","signature","wrap","_callee$","_context","prev","next","abrupt","loginMetamask","then","res","status","data","stop","_x","_x2","apply","arguments","login","_ref2","_callee2","signer","nonce","loginData","_callee2$","_context2","SET_PENDING_LOADER","ethereumListener","logout","getSigner","sent","getAddress","getNonce","signMessage","concat","catch","token","user","SET_USER","use","LOGOUT"],"sources":["/Users/apple/Documents/treasure/src/hooks/auth/useHandleAuth.js"],"sourcesContent":["import AuthApi from \"../../api/AuthApi\";\nimport { localStorageRemove, localStorageSet } from \"../../utils/localStorage\";\nimport useHandleCustomer from \"../customer/useHandleCustomer\";\nimport { useNavigate } from \"react-router-dom\";\nimport useWalletConnect from \"../blockchain/useWalletConnect\";\nimport { useWeb3React } from \"@web3-react/core\";\nimport ACTIONS from \"redux/action\";\nimport { useDispatch } from \"react-redux\";\nimport useGetSigner from \"hooks/blockchain/useHandleContracts\";\n\nexport default function useHandleAuth() {\n  const navigate = useNavigate();\n  const dispatch = useDispatch();\n  const handleAdmin = useHandleCustomer();\n  const walletConnect = useWalletConnect();\n  const { library, deactivate } = useWeb3React();\n  const handleGetSigner = useGetSigner();\n\n  const fetchLoginMetamask = async (address, signature) => {\n    return new AuthApi()\n      .loginMetamask({ address, signature })\n      .then((res) => (res?.status ? res?.data : null));\n  };\n\n  const login = async () => {\n    ACTIONS.SET_PENDING_LOADER(dispatch, true);\n\n    await walletConnect.ethereumListener(logout);\n    let signer;\n\n    if (library) {\n      signer = library.getSigner();\n    } else {\n      signer = await handleGetSigner;\n    }\n    const address = await signer.getAddress();\n\n    if (!address) return ACTIONS.SET_PENDING_LOADER(dispatch, false);\n\n    const nonce = await handleAdmin.getNonce(address);\n    if (!nonce) return ACTIONS.SET_PENDING_LOADER(dispatch, false);\n\n    const signature = await signer\n      .signMessage(`I am signing my one-time nonce: ${nonce}`)\n      .catch(() => null);\n    if (!signature) return ACTIONS.SET_PENDING_LOADER(dispatch, false);\n\n    const loginData = await fetchLoginMetamask(address, signature);\n    if (!loginData?.token || !loginData?.user)\n      return ACTIONS.SET_PENDING_LOADER(dispatch, false);\n    ACTIONS.SET_USER(dispatch, loginData?.use);\n    localStorageSet(\"token\", loginData?.token);\n    ACTIONS.SET_PENDING_LOADER(dispatch, false);\n  };\n\n  const logout = () => {\n    localStorageRemove(\"token\");\n    deactivate();\n    localStorageRemove(\"isWalletConnected\");\n    ACTIONS.LOGOUT(dispatch);\n    navigate(\"/\");\n  };\n\n  return { login, logout };\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}