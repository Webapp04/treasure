{"ast":null,"code":"var _classCallCheck = require(\"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/classCallCheck.js\").default;\nvar _createClass = require(\"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/createClass.js\").default;\nvar Record = require('./Record');\nvar RateLimiterRes = require('../../RateLimiterRes');\nmodule.exports = /*#__PURE__*/function () {\n  \"use strict\";\n\n  function MemoryStorage() {\n    _classCallCheck(this, MemoryStorage);\n    /**\n     * @type {Object.<string, Record>}\n     * @private\n     */\n    this._storage = {};\n  }\n  _createClass(MemoryStorage, [{\n    key: \"incrby\",\n    value: function incrby(key, value, durationSec) {\n      if (this._storage[key]) {\n        var msBeforeExpires = this._storage[key].expiresAt ? this._storage[key].expiresAt.getTime() - new Date().getTime() : -1;\n        if (msBeforeExpires !== 0) {\n          // Change value\n          this._storage[key].value = this._storage[key].value + value;\n          return new RateLimiterRes(0, msBeforeExpires, this._storage[key].value, false);\n        }\n        return this.set(key, value, durationSec);\n      }\n      return this.set(key, value, durationSec);\n    }\n  }, {\n    key: \"set\",\n    value: function set(key, value, durationSec) {\n      var _this = this;\n      var durationMs = durationSec * 1000;\n      if (this._storage[key] && this._storage[key].timeoutId) {\n        clearTimeout(this._storage[key].timeoutId);\n      }\n      this._storage[key] = new Record(value, durationMs > 0 ? new Date(Date.now() + durationMs) : null);\n      if (durationMs > 0) {\n        this._storage[key].timeoutId = setTimeout(function () {\n          delete _this._storage[key];\n        }, durationMs);\n        if (this._storage[key].timeoutId.unref) {\n          this._storage[key].timeoutId.unref();\n        }\n      }\n      return new RateLimiterRes(0, durationMs === 0 ? -1 : durationMs, this._storage[key].value, true);\n    }\n\n    /**\n     *\n     * @param key\n     * @returns {*}\n     */\n  }, {\n    key: \"get\",\n    value: function get(key) {\n      if (this._storage[key]) {\n        var msBeforeExpires = this._storage[key].expiresAt ? this._storage[key].expiresAt.getTime() - new Date().getTime() : -1;\n        return new RateLimiterRes(0, msBeforeExpires, this._storage[key].value, false);\n      }\n      return null;\n    }\n\n    /**\n     *\n     * @param key\n     * @returns {boolean}\n     */\n  }, {\n    key: \"delete\",\n    value: function _delete(key) {\n      if (this._storage[key]) {\n        if (this._storage[key].timeoutId) {\n          clearTimeout(this._storage[key].timeoutId);\n        }\n        delete this._storage[key];\n        return true;\n      }\n      return false;\n    }\n  }]);\n  return MemoryStorage;\n}();","map":{"version":3,"names":["Record","require","RateLimiterRes","module","exports","MemoryStorage","_classCallCheck","_storage","_createClass","key","value","incrby","durationSec","msBeforeExpires","expiresAt","getTime","Date","set","_this","durationMs","timeoutId","clearTimeout","now","setTimeout","unref","get","_delete"],"sources":["/Users/apple/Documents/treasure/node_modules/rate-limiter-flexible/lib/component/MemoryStorage/MemoryStorage.js"],"sourcesContent":["const Record = require('./Record');\nconst RateLimiterRes = require('../../RateLimiterRes');\n\nmodule.exports = class MemoryStorage {\n  constructor() {\n    /**\n     * @type {Object.<string, Record>}\n     * @private\n     */\n    this._storage = {};\n  }\n\n  incrby(key, value, durationSec) {\n    if (this._storage[key]) {\n      const msBeforeExpires = this._storage[key].expiresAt\n        ? this._storage[key].expiresAt.getTime() - new Date().getTime()\n        : -1;\n      if (msBeforeExpires !== 0) {\n        // Change value\n        this._storage[key].value = this._storage[key].value + value;\n\n        return new RateLimiterRes(0, msBeforeExpires, this._storage[key].value, false);\n      }\n\n      return this.set(key, value, durationSec);\n    }\n    return this.set(key, value, durationSec);\n  }\n\n  set(key, value, durationSec) {\n    const durationMs = durationSec * 1000;\n\n    if (this._storage[key] && this._storage[key].timeoutId) {\n      clearTimeout(this._storage[key].timeoutId);\n    }\n\n    this._storage[key] = new Record(\n      value,\n      durationMs > 0 ? new Date(Date.now() + durationMs) : null\n    );\n    if (durationMs > 0) {\n      this._storage[key].timeoutId = setTimeout(() => {\n        delete this._storage[key];\n      }, durationMs);\n      if (this._storage[key].timeoutId.unref) {\n        this._storage[key].timeoutId.unref();\n      }\n    }\n\n    return new RateLimiterRes(0, durationMs === 0 ? -1 : durationMs, this._storage[key].value, true);\n  }\n\n  /**\n   *\n   * @param key\n   * @returns {*}\n   */\n  get(key) {\n    if (this._storage[key]) {\n      const msBeforeExpires = this._storage[key].expiresAt\n        ? this._storage[key].expiresAt.getTime() - new Date().getTime()\n        : -1;\n      return new RateLimiterRes(0, msBeforeExpires, this._storage[key].value, false);\n    }\n    return null;\n  }\n\n  /**\n   *\n   * @param key\n   * @returns {boolean}\n   */\n  delete(key) {\n    if (this._storage[key]) {\n      if (this._storage[key].timeoutId) {\n        clearTimeout(this._storage[key].timeoutId);\n      }\n      delete this._storage[key];\n      return true;\n    }\n    return false;\n  }\n};\n"],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}