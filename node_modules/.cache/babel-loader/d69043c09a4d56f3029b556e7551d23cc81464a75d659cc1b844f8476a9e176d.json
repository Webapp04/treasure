{"ast":null,"code":"import _regeneratorRuntime from \"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";\nimport _asyncToGenerator from \"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport _classCallCheck from \"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";\nimport _createClass from \"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/createClass.js\";\nimport _inherits from \"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/inherits.js\";\nimport _createSuper from \"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/createSuper.js\";\nimport { EventEmitter } from '@libp2p/interfaces/events';\nimport errCode from 'err-code';\nexport var WebRTCHandshake = /*#__PURE__*/function (_EventEmitter) {\n  _inherits(WebRTCHandshake, _EventEmitter);\n  var _super = _createSuper(WebRTCHandshake);\n  function WebRTCHandshake(options) {\n    var _this;\n    _classCallCheck(this, WebRTCHandshake);\n    _this = _super.call(this);\n    _this.log = options.log;\n    _this.peerConnection = options.peerConnection;\n    _this.wrtc = options.wrtc;\n    _this.status = 'idle';\n    _this.peerConnection.addEventListener('negotiationneeded', function () {\n      _this.log('peer connection negotiation needed');\n      _this.handleRenegotiate({\n        type: 'renegotiate'\n      }).catch(function (err) {\n        _this.log.error('could not renegotiate %o', err);\n      });\n    });\n    return _this;\n  }\n  _createClass(WebRTCHandshake, [{\n    key: \"handleSignal\",\n    value: function () {\n      var _handleSignal = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee(signal) {\n        return _regeneratorRuntime().wrap(function _callee$(_context) {\n          while (1) switch (_context.prev = _context.next) {\n            case 0:\n              this.log('incoming signal \"%s\"', signal.type);\n              if (!(signal.type === 'offer')) {\n                _context.next = 7;\n                break;\n              }\n              _context.next = 4;\n              return this.handleOffer(signal);\n            case 4:\n              return _context.abrupt(\"return\", _context.sent);\n            case 7:\n              if (!(signal.type === 'answer')) {\n                _context.next = 13;\n                break;\n              }\n              _context.next = 10;\n              return this.handleAnswer(signal);\n            case 10:\n              return _context.abrupt(\"return\", _context.sent);\n            case 13:\n              if (!(signal.type === 'candidate')) {\n                _context.next = 19;\n                break;\n              }\n              _context.next = 16;\n              return this.handleCandidate(signal);\n            case 16:\n              return _context.abrupt(\"return\", _context.sent);\n            case 19:\n              if (!(signal.type === 'renegotiate')) {\n                _context.next = 25;\n                break;\n              }\n              _context.next = 22;\n              return this.handleRenegotiate(signal);\n            case 22:\n              return _context.abrupt(\"return\", _context.sent);\n            case 25:\n              if (!(signal.type === 'goodbye')) {\n                _context.next = 31;\n                break;\n              }\n              _context.next = 28;\n              return this.handleGoodye(signal);\n            case 28:\n              return _context.abrupt(\"return\", _context.sent);\n            case 31:\n              // @ts-expect-error all types are handled above\n              this.log(\"Unknown signal type \".concat(signal.type)); // eslint-disable-line @typescript-eslint/restrict-template-expressions\n            case 32:\n            case \"end\":\n              return _context.stop();\n          }\n        }, _callee, this);\n      }));\n      function handleSignal(_x) {\n        return _handleSignal.apply(this, arguments);\n      }\n      return handleSignal;\n    }()\n  }, {\n    key: \"handleOffer\",\n    value: function () {\n      var _handleOffer = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee2(signal) {\n        return _regeneratorRuntime().wrap(function _callee2$(_context2) {\n          while (1) switch (_context2.prev = _context2.next) {\n            case 0:\n            case \"end\":\n              return _context2.stop();\n          }\n        }, _callee2);\n      }));\n      function handleOffer(_x2) {\n        return _handleOffer.apply(this, arguments);\n      }\n      return handleOffer;\n    }()\n  }, {\n    key: \"handleAnswer\",\n    value: function () {\n      var _handleAnswer = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee3(signal) {\n        return _regeneratorRuntime().wrap(function _callee3$(_context3) {\n          while (1) switch (_context3.prev = _context3.next) {\n            case 0:\n            case \"end\":\n              return _context3.stop();\n          }\n        }, _callee3);\n      }));\n      function handleAnswer(_x3) {\n        return _handleAnswer.apply(this, arguments);\n      }\n      return handleAnswer;\n    }()\n  }, {\n    key: \"handleRenegotiate\",\n    value: function () {\n      var _handleRenegotiate = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee4(signal) {\n        return _regeneratorRuntime().wrap(function _callee4$(_context4) {\n          while (1) switch (_context4.prev = _context4.next) {\n            case 0:\n            case \"end\":\n              return _context4.stop();\n          }\n        }, _callee4);\n      }));\n      function handleRenegotiate(_x4) {\n        return _handleRenegotiate.apply(this, arguments);\n      }\n      return handleRenegotiate;\n    }()\n  }, {\n    key: \"handleGoodye\",\n    value: function () {\n      var _handleGoodye = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee5(signal) {\n        return _regeneratorRuntime().wrap(function _callee5$(_context5) {\n          while (1) switch (_context5.prev = _context5.next) {\n            case 0:\n              this.peerConnection.close();\n            case 1:\n            case \"end\":\n              return _context5.stop();\n          }\n        }, _callee5, this);\n      }));\n      function handleGoodye(_x5) {\n        return _handleGoodye.apply(this, arguments);\n      }\n      return handleGoodye;\n    }()\n  }, {\n    key: \"handleCandidate\",\n    value: function () {\n      var _handleCandidate = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee6(signal) {\n        var iceCandidate;\n        return _regeneratorRuntime().wrap(function _callee6$(_context6) {\n          while (1) switch (_context6.prev = _context6.next) {\n            case 0:\n              iceCandidate = new this.wrtc.RTCIceCandidate(signal.candidate);\n              _context6.prev = 1;\n              _context6.next = 4;\n              return this.peerConnection.addIceCandidate(iceCandidate);\n            case 4:\n              _context6.next = 13;\n              break;\n            case 6:\n              _context6.prev = 6;\n              _context6.t0 = _context6[\"catch\"](1);\n              if (!(iceCandidate.address == null || iceCandidate.address.endsWith('.local'))) {\n                _context6.next = 12;\n                break;\n              }\n              this.log('ignoring unsupported ICE candidate.');\n              _context6.next = 13;\n              break;\n            case 12:\n              throw errCode(_context6.t0, 'ERR_ADD_ICE_CANDIDATE');\n            case 13:\n            case \"end\":\n              return _context6.stop();\n          }\n        }, _callee6, this, [[1, 6]]);\n      }));\n      function handleCandidate(_x6) {\n        return _handleCandidate.apply(this, arguments);\n      }\n      return handleCandidate;\n    }()\n  }]);\n  return WebRTCHandshake;\n}(EventEmitter);","map":{"version":3,"names":["EventEmitter","errCode","WebRTCHandshake","_EventEmitter","_inherits","_super","_createSuper","options","_this","_classCallCheck","call","log","peerConnection","wrtc","status","addEventListener","handleRenegotiate","type","catch","err","error","_createClass","key","value","_handleSignal","_asyncToGenerator","_regeneratorRuntime","mark","_callee","signal","wrap","_callee$","_context","prev","next","handleOffer","abrupt","sent","handleAnswer","handleCandidate","handleGoodye","concat","stop","handleSignal","_x","apply","arguments","_handleOffer","_callee2","_callee2$","_context2","_x2","_handleAnswer","_callee3","_callee3$","_context3","_x3","_handleRenegotiate","_callee4","_callee4$","_context4","_x4","_handleGoodye","_callee5","_callee5$","_context5","close","_x5","_handleCandidate","_callee6","iceCandidate","_callee6$","_context6","RTCIceCandidate","candidate","addIceCandidate","t0","address","endsWith","_x6"],"sources":["/Users/apple/Documents/treasure/node_modules/@libp2p/webrtc-peer/src/handshake.ts"],"sourcesContent":["import { EventEmitter } from '@libp2p/interfaces/events'\nimport errCode from 'err-code'\nimport type { WebRTCPeerEvents, WRTC, Signal, OfferSignal, AnswerSignal, CandidateSignal, RenegotiateSignal, GoodbyeSignal } from './index.js'\nimport type { Logger } from '@libp2p/logger'\n\nexport interface WebRTCHandshakeOptions {\n  log: Logger\n  peerConnection: RTCPeerConnection\n  offerOptions?: RTCOfferOptions\n  wrtc: WRTC\n}\n\nexport class WebRTCHandshake extends EventEmitter<WebRTCPeerEvents> {\n  protected log: Logger\n  protected peerConnection: RTCPeerConnection\n  protected status: 'idle' | 'negotiating'\n  protected wrtc: WRTC\n\n  constructor (options: WebRTCHandshakeOptions) {\n    super()\n\n    this.log = options.log\n    this.peerConnection = options.peerConnection\n    this.wrtc = options.wrtc\n    this.status = 'idle'\n\n    this.peerConnection.addEventListener('negotiationneeded', () => {\n      this.log('peer connection negotiation needed')\n\n      this.handleRenegotiate({ type: 'renegotiate' }).catch(err => {\n        this.log.error('could not renegotiate %o', err)\n      })\n    })\n  }\n\n  async handleSignal (signal: Signal) {\n    this.log('incoming signal \"%s\"', signal.type)\n\n    if (signal.type === 'offer') {\n      return await this.handleOffer(signal)\n    } else if (signal.type === 'answer') {\n      return await this.handleAnswer(signal)\n    } else if (signal.type === 'candidate') {\n      return await this.handleCandidate(signal)\n    } else if (signal.type === 'renegotiate') {\n      return await this.handleRenegotiate(signal)\n    } else if (signal.type === 'goodbye') {\n      return await this.handleGoodye(signal)\n    } else {\n      // @ts-expect-error all types are handled above\n      this.log(`Unknown signal type ${signal.type}`) // eslint-disable-line @typescript-eslint/restrict-template-expressions\n    }\n  }\n\n  async handleOffer (signal: OfferSignal) {}\n  async handleAnswer (signal: AnswerSignal) {}\n  async handleRenegotiate (signal: RenegotiateSignal) {}\n  async handleGoodye (signal: GoodbyeSignal) {\n    this.peerConnection.close()\n  }\n\n  async handleCandidate (signal: CandidateSignal) {\n    const iceCandidate = new this.wrtc.RTCIceCandidate(signal.candidate)\n\n    try {\n      await this.peerConnection.addIceCandidate(iceCandidate)\n    } catch (err) {\n      if (iceCandidate.address == null || iceCandidate.address.endsWith('.local')) {\n        this.log('ignoring unsupported ICE candidate.')\n      } else {\n        throw errCode(err, 'ERR_ADD_ICE_CANDIDATE')\n      }\n    }\n  }\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}