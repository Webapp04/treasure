{"ast":null,"code":"var _classCallCheck = require(\"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/classCallCheck.js\").default;\nvar _createClass = require(\"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/createClass.js\").default;\nvar RateLimiterQueueError = require('./component/RateLimiterQueueError');\nvar MAX_QUEUE_SIZE = 4294967295;\nvar KEY_DEFAULT = 'limiter';\nmodule.exports = /*#__PURE__*/function () {\n  \"use strict\";\n\n  function RateLimiterQueue(limiterFlexible) {\n    var opts = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {\n      maxQueueSize: MAX_QUEUE_SIZE\n    };\n    _classCallCheck(this, RateLimiterQueue);\n    this._queueLimiters = {\n      KEY_DEFAULT: new RateLimiterQueueInternal(limiterFlexible, opts)\n    };\n    this._limiterFlexible = limiterFlexible;\n    this._maxQueueSize = opts.maxQueueSize;\n  }\n  _createClass(RateLimiterQueue, [{\n    key: \"getTokensRemaining\",\n    value: function getTokensRemaining() {\n      var key = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : KEY_DEFAULT;\n      if (this._queueLimiters[key]) {\n        return this._queueLimiters[key].getTokensRemaining();\n      } else {\n        return Promise.resolve(this._limiterFlexible.points);\n      }\n    }\n  }, {\n    key: \"removeTokens\",\n    value: function removeTokens(tokens) {\n      var key = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : KEY_DEFAULT;\n      if (!this._queueLimiters[key]) {\n        this._queueLimiters[key] = new RateLimiterQueueInternal(this._limiterFlexible, {\n          key: key,\n          maxQueueSize: this._maxQueueSize\n        });\n      }\n      return this._queueLimiters[key].removeTokens(tokens);\n    }\n  }]);\n  return RateLimiterQueue;\n}();\nvar RateLimiterQueueInternal = /*#__PURE__*/function () {\n  \"use strict\";\n\n  function RateLimiterQueueInternal(limiterFlexible) {\n    var opts = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {\n      maxQueueSize: MAX_QUEUE_SIZE,\n      key: KEY_DEFAULT\n    };\n    _classCallCheck(this, RateLimiterQueueInternal);\n    this._key = opts.key;\n    this._waitTimeout = null;\n    this._queue = [];\n    this._limiterFlexible = limiterFlexible;\n    this._maxQueueSize = opts.maxQueueSize;\n  }\n  _createClass(RateLimiterQueueInternal, [{\n    key: \"getTokensRemaining\",\n    value: function getTokensRemaining() {\n      var _this2 = this;\n      return this._limiterFlexible.get(this._key).then(function (rlRes) {\n        return rlRes !== null ? rlRes.remainingPoints : _this2._limiterFlexible.points;\n      });\n    }\n  }, {\n    key: \"removeTokens\",\n    value: function removeTokens(tokens) {\n      var _this = this;\n      return new Promise(function (resolve, reject) {\n        if (tokens > _this._limiterFlexible.points) {\n          reject(new RateLimiterQueueError(\"Requested tokens \".concat(tokens, \" exceeds maximum \").concat(_this._limiterFlexible.points, \" tokens per interval\")));\n          return;\n        }\n        if (_this._queue.length > 0) {\n          _this._queueRequest.call(_this, resolve, reject, tokens);\n        } else {\n          _this._limiterFlexible.consume(_this._key, tokens).then(function (res) {\n            resolve(res.remainingPoints);\n          }).catch(function (rej) {\n            if (rej instanceof Error) {\n              reject(rej);\n            } else {\n              _this._queueRequest.call(_this, resolve, reject, tokens);\n              if (_this._waitTimeout === null) {\n                _this._waitTimeout = setTimeout(_this._processFIFO.bind(_this), rej.msBeforeNext);\n              }\n            }\n          });\n        }\n      });\n    }\n  }, {\n    key: \"_queueRequest\",\n    value: function _queueRequest(resolve, reject, tokens) {\n      var _this = this;\n      if (_this._queue.length < _this._maxQueueSize) {\n        _this._queue.push({\n          resolve: resolve,\n          reject: reject,\n          tokens: tokens\n        });\n      } else {\n        reject(new RateLimiterQueueError(\"Number of requests reached it's maximum \".concat(_this._maxQueueSize)));\n      }\n    }\n  }, {\n    key: \"_processFIFO\",\n    value: function _processFIFO() {\n      var _this = this;\n      if (_this._waitTimeout !== null) {\n        clearTimeout(_this._waitTimeout);\n        _this._waitTimeout = null;\n      }\n      if (_this._queue.length === 0) {\n        return;\n      }\n      var item = _this._queue.shift();\n      _this._limiterFlexible.consume(_this._key, item.tokens).then(function (res) {\n        item.resolve(res.remainingPoints);\n        _this._processFIFO.call(_this);\n      }).catch(function (rej) {\n        if (rej instanceof Error) {\n          item.reject(rej);\n          _this._processFIFO.call(_this);\n        } else {\n          _this._queue.unshift(item);\n          if (_this._waitTimeout === null) {\n            _this._waitTimeout = setTimeout(_this._processFIFO.bind(_this), rej.msBeforeNext);\n          }\n        }\n      });\n    }\n  }]);\n  return RateLimiterQueueInternal;\n}();","map":{"version":3,"names":["RateLimiterQueueError","require","MAX_QUEUE_SIZE","KEY_DEFAULT","module","exports","RateLimiterQueue","limiterFlexible","opts","arguments","length","undefined","maxQueueSize","_classCallCheck","_queueLimiters","RateLimiterQueueInternal","_limiterFlexible","_maxQueueSize","_createClass","key","value","getTokensRemaining","Promise","resolve","points","removeTokens","tokens","_key","_waitTimeout","_queue","_this2","get","then","rlRes","remainingPoints","_this","reject","concat","_queueRequest","call","consume","res","catch","rej","Error","setTimeout","_processFIFO","bind","msBeforeNext","push","clearTimeout","item","shift","unshift"],"sources":["/Users/apple/Documents/treasure/node_modules/rate-limiter-flexible/lib/RateLimiterQueue.js"],"sourcesContent":["const RateLimiterQueueError = require('./component/RateLimiterQueueError')\nconst MAX_QUEUE_SIZE = 4294967295;\nconst KEY_DEFAULT = 'limiter';\n\nmodule.exports = class RateLimiterQueue {\n  constructor(limiterFlexible, opts = {\n    maxQueueSize: MAX_QUEUE_SIZE,\n  }) {\n    this._queueLimiters = {\n      KEY_DEFAULT: new RateLimiterQueueInternal(limiterFlexible, opts)\n    };\n    this._limiterFlexible = limiterFlexible;\n    this._maxQueueSize = opts.maxQueueSize\n  }\n\n  getTokensRemaining(key = KEY_DEFAULT) {\n    if (this._queueLimiters[key]) {\n      return this._queueLimiters[key].getTokensRemaining()\n    } else {\n      return Promise.resolve(this._limiterFlexible.points)\n    }\n  }\n\n  removeTokens(tokens, key = KEY_DEFAULT) {\n    if (!this._queueLimiters[key]) {\n      this._queueLimiters[key] = new RateLimiterQueueInternal(\n        this._limiterFlexible, {\n          key,\n          maxQueueSize: this._maxQueueSize,\n        })\n    }\n\n    return this._queueLimiters[key].removeTokens(tokens)\n  }\n};\n\nclass RateLimiterQueueInternal {\n\n  constructor(limiterFlexible, opts = {\n    maxQueueSize: MAX_QUEUE_SIZE,\n    key: KEY_DEFAULT,\n  }) {\n    this._key = opts.key;\n    this._waitTimeout = null;\n    this._queue = [];\n    this._limiterFlexible = limiterFlexible;\n\n    this._maxQueueSize = opts.maxQueueSize\n  }\n\n  getTokensRemaining() {\n    return this._limiterFlexible.get(this._key)\n      .then((rlRes) => {\n        return rlRes !== null ? rlRes.remainingPoints : this._limiterFlexible.points;\n      })\n  }\n\n  removeTokens(tokens) {\n    const _this = this;\n\n    return new Promise((resolve, reject) => {\n      if (tokens > _this._limiterFlexible.points) {\n        reject(new RateLimiterQueueError(`Requested tokens ${tokens} exceeds maximum ${_this._limiterFlexible.points} tokens per interval`));\n        return\n      }\n\n      if (_this._queue.length > 0) {\n        _this._queueRequest.call(_this, resolve, reject, tokens);\n      } else {\n        _this._limiterFlexible.consume(_this._key, tokens)\n          .then((res) => {\n            resolve(res.remainingPoints);\n          })\n          .catch((rej) => {\n            if (rej instanceof Error) {\n              reject(rej);\n            } else {\n              _this._queueRequest.call(_this, resolve, reject, tokens);\n              if (_this._waitTimeout === null) {\n                _this._waitTimeout = setTimeout(_this._processFIFO.bind(_this), rej.msBeforeNext);\n              }\n            }\n          });\n      }\n    })\n  }\n\n  _queueRequest(resolve, reject, tokens) {\n    const _this = this;\n    if (_this._queue.length < _this._maxQueueSize) {\n      _this._queue.push({resolve, reject, tokens});\n    } else {\n      reject(new RateLimiterQueueError(`Number of requests reached it's maximum ${_this._maxQueueSize}`))\n    }\n  }\n\n  _processFIFO() {\n    const _this = this;\n\n    if (_this._waitTimeout !== null) {\n      clearTimeout(_this._waitTimeout);\n      _this._waitTimeout = null;\n    }\n\n    if (_this._queue.length === 0) {\n      return;\n    }\n\n    const item = _this._queue.shift();\n    _this._limiterFlexible.consume(_this._key, item.tokens)\n      .then((res) => {\n        item.resolve(res.remainingPoints);\n        _this._processFIFO.call(_this);\n      })\n      .catch((rej) => {\n        if (rej instanceof Error) {\n          item.reject(rej);\n          _this._processFIFO.call(_this);\n        } else {\n          _this._queue.unshift(item);\n          if (_this._waitTimeout === null) {\n            _this._waitTimeout = setTimeout(_this._processFIFO.bind(_this), rej.msBeforeNext);\n          }\n        }\n      });\n  }\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}