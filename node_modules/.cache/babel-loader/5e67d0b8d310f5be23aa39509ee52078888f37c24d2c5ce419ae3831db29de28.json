{"ast":null,"code":"import _regeneratorRuntime from\"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";import _createForOfIteratorHelper from\"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper.js\";import _asyncToGenerator from\"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import AirdropApi from\"api/AirdropApi\";import useHandleToastAlert from\"hooks/alert/useHandleToastAlert\";import useHandleCustomer from\"hooks/customer/useHandleCustomer\";import useHandleToken from\"hooks/token/useHandleToken\";import{useDispatch,useSelector}from\"react-redux\";import ACTIONS from\"redux/action\";import{selectAvaxBalance}from\"redux/slice/balanceSlice\";import{selectUser}from\"redux/slice/userSlice\";import useGetZoneCommission from\"./useGetZoneCommission\";import useReloadNFTItemBalance from\"./useReloadNFTItemBalance\";import{useContractNFKeyWithSigner}from\"hooks/blockchain/useHandleContracts\";export default function useMint(){var user=useSelector(selectUser);var avaxBalance=useSelector(selectAvaxBalance);var dispatch=useDispatch();var handleCustomer=useHandleCustomer();var handleToastAlert=useHandleToastAlert();var handleToken=useHandleToken();var handleGetZoneCommission=useGetZoneCommission();var handleReloadNFTItemBalance=useReloadNFTItemBalance();var handleContractNFKeyWithSigner=useContractNFKeyWithSigner();var mint=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee2(zone,amount){var commission,merkle_data,merkle_proof,merkle_wl,contractNFKeyWithSigner;return _regeneratorRuntime().wrap(function _callee2$(_context2){while(1)switch(_context2.prev=_context2.next){case 0:_context2.next=2;return handleGetZoneCommission===null||handleGetZoneCommission===void 0?void 0:handleGetZoneCommission.getZoneCommission(user===null||user===void 0?void 0:user.wallet_id,zone);case 2:commission=_context2.sent;_context2.next=5;return handleCustomer.getMerkleTree(user===null||user===void 0?void 0:user.wallet_id);case 5:merkle_data=_context2.sent;merkle_proof=merkle_data[0].proof;merkle_wl={whitelistAddress:merkle_data[0].whitelistAddress,level:merkle_data[0].level,zone1:merkle_data[0].zone1,zone2:merkle_data[0].zone2,zone3:merkle_data[0].zone3,zone4:merkle_data[0].zone4};if(!(commission*amount>avaxBalance*Math.pow(10,18))){_context2.next=12;break;}handleToastAlert.error(\"Insufficient balance\");new AirdropApi().logger({wallet_id:user===null||user===void 0?void 0:user.wallet_id,type:\"ERROR\",action:\"mint\",description:\"Insufficient balance\",error:JSON.stringify(\"Insufficient balance\")});return _context2.abrupt(\"return\");case 12:_context2.next=14;return handleContractNFKeyWithSigner;case 14:contractNFKeyWithSigner=_context2.sent;return _context2.abrupt(\"return\",contractNFKeyWithSigner.bulkMint(user===null||user===void 0?void 0:user.wallet_id,zone,amount,merkle_wl,merkle_proof,{value:(commission*amount).toString()}).then(/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee(tx){var _answer$logs;var answer,transactionLogList,_iterator,_step,transactionLog,tokenID;return _regeneratorRuntime().wrap(function _callee$(_context){while(1)switch(_context.prev=_context.next){case 0:new AirdropApi().logger({wallet_id:user===null||user===void 0?void 0:user.wallet_id,type:\"PENDING\",action:\"mint\",description:\"HomeMint unique token\",tx:JSON.stringify(tx)});_context.next=3;return tx.wait();case 3:answer=_context.sent;_context.next=6;return handleToken.getcheckTxEvent(tx===null||tx===void 0?void 0:tx.hash,\"BatchMinted\");case 6:ACTIONS.SET_TRANSANCTION_HASH(dispatch,tx===null||tx===void 0?void 0:tx.hash);transactionLogList=answer===null||answer===void 0?void 0:(_answer$logs=answer.logs)===null||_answer$logs===void 0?void 0:_answer$logs.filter(function(log){return(log===null||log===void 0?void 0:log.address)===process.env.REACT_APP_NFKEY_ADDRESS;});_iterator=_createForOfIteratorHelper(transactionLogList);_context.prev=9;_iterator.s();case 11:if((_step=_iterator.n()).done){_context.next=19;break;}transactionLog=_step.value;tokenID=parseInt(transactionLog===null||transactionLog===void 0?void 0:transactionLog.topics[3],16);// FIXME: should remove this\nif(!(+tokenID>0&&+tokenID<10000)){_context.next=17;break;}_context.next=17;return handleReloadNFTItemBalance.reloadNFTItemBalance(process.env.REACT_APP_NFKEY_ADDRESS,tokenID);case 17:_context.next=11;break;case 19:_context.next=24;break;case 21:_context.prev=21;_context.t0=_context[\"catch\"](9);_iterator.e(_context.t0);case 24:_context.prev=24;_iterator.f();return _context.finish(24);case 27:return _context.abrupt(\"return\",transactionLogList);case 28:case\"end\":return _context.stop();}},_callee,null,[[9,21,24,27]]);}));return function(_x3){return _ref2.apply(this,arguments);};}()).catch(function(err){new AirdropApi().logger({wallet_id:user===null||user===void 0?void 0:user.wallet_id,type:\"ERROR\",action:\"mint\",description:\"HomeMint unique token\",error:JSON.stringify(err)});}));case 16:case\"end\":return _context2.stop();}},_callee2);}));return function mint(_x,_x2){return _ref.apply(this,arguments);};}();return{mint:mint};}","map":{"version":3,"names":["AirdropApi","useHandleToastAlert","useHandleCustomer","useHandleToken","useDispatch","useSelector","ACTIONS","selectAvaxBalance","selectUser","useGetZoneCommission","useReloadNFTItemBalance","useContractNFKeyWithSigner","useMint","user","avaxBalance","dispatch","handleCustomer","handleToastAlert","handleToken","handleGetZoneCommission","handleReloadNFTItemBalance","handleContractNFKeyWithSigner","mint","_ref","_asyncToGenerator","_regeneratorRuntime","mark","_callee2","zone","amount","commission","merkle_data","merkle_proof","merkle_wl","contractNFKeyWithSigner","wrap","_callee2$","_context2","prev","next","getZoneCommission","wallet_id","sent","getMerkleTree","proof","whitelistAddress","level","zone1","zone2","zone3","zone4","Math","pow","error","logger","type","action","description","JSON","stringify","abrupt","bulkMint","value","toString","then","_ref2","_callee","tx","_answer$logs","answer","transactionLogList","_iterator","_step","transactionLog","tokenID","_callee$","_context","wait","getcheckTxEvent","hash","SET_TRANSANCTION_HASH","logs","filter","log","address","process","env","REACT_APP_NFKEY_ADDRESS","_createForOfIteratorHelper","s","n","done","parseInt","topics","reloadNFTItemBalance","t0","e","f","finish","stop","_x3","apply","arguments","catch","err","_x","_x2"],"sources":["/Users/apple/Documents/treasure/src/hooks/nft/useMint.js"],"sourcesContent":["import AirdropApi from \"api/AirdropApi\";\nimport useHandleToastAlert from \"hooks/alert/useHandleToastAlert\";\nimport useHandleCustomer from \"hooks/customer/useHandleCustomer\";\nimport useHandleToken from \"hooks/token/useHandleToken\";\nimport { useDispatch, useSelector } from \"react-redux\";\nimport ACTIONS from \"redux/action\";\nimport { selectAvaxBalance } from \"redux/slice/balanceSlice\";\nimport { selectUser } from \"redux/slice/userSlice\";\nimport useGetZoneCommission from \"./useGetZoneCommission\";\nimport useReloadNFTItemBalance from \"./useReloadNFTItemBalance\";\nimport { useContractNFKeyWithSigner } from \"hooks/blockchain/useHandleContracts\";\n\nexport default function useMint() {\n  const user = useSelector(selectUser);\n  const avaxBalance = useSelector(selectAvaxBalance);\n  const dispatch = useDispatch();\n  const handleCustomer = useHandleCustomer();\n  const handleToastAlert = useHandleToastAlert();\n  const handleToken = useHandleToken();\n  const handleGetZoneCommission = useGetZoneCommission();\n  const handleReloadNFTItemBalance = useReloadNFTItemBalance();\n  const handleContractNFKeyWithSigner = useContractNFKeyWithSigner();\n\n  const mint = async (zone, amount) => {\n    const commission = await handleGetZoneCommission?.getZoneCommission(\n      user?.wallet_id,\n      zone\n    );\n    const merkle_data = await handleCustomer.getMerkleTree(user?.wallet_id);\n    const merkle_proof = merkle_data[0].proof;\n    const merkle_wl = {\n      whitelistAddress: merkle_data[0].whitelistAddress,\n      level: merkle_data[0].level,\n      zone1: merkle_data[0].zone1,\n      zone2: merkle_data[0].zone2,\n      zone3: merkle_data[0].zone3,\n      zone4: merkle_data[0].zone4,\n    };\n    if (commission * amount > avaxBalance * 10 ** 18) {\n      handleToastAlert.error(\"Insufficient balance\");\n      new AirdropApi().logger({\n        wallet_id: user?.wallet_id,\n        type: \"ERROR\",\n        action: \"mint\",\n        description: \"Insufficient balance\",\n        error: JSON.stringify(\"Insufficient balance\"),\n      });\n      return;\n    }\n    const contractNFKeyWithSigner = await handleContractNFKeyWithSigner;\n    return contractNFKeyWithSigner\n      .bulkMint(user?.wallet_id, zone, amount, merkle_wl, merkle_proof, {\n        value: (commission * amount).toString(),\n      })\n      .then(async (tx) => {\n        new AirdropApi().logger({\n          wallet_id: user?.wallet_id,\n          type: \"PENDING\",\n          action: \"mint\",\n          description: \"HomeMint unique token\",\n          tx: JSON.stringify(tx),\n        });\n        const answer = await tx.wait();\n        await handleToken.getcheckTxEvent(tx?.hash, \"BatchMinted\");\n        ACTIONS.SET_TRANSANCTION_HASH(dispatch, tx?.hash);\n        const transactionLogList = answer?.logs?.filter(\n          (log) => log?.address === process.env.REACT_APP_NFKEY_ADDRESS\n        );\n        for (const transactionLog of transactionLogList) {\n          const tokenID = parseInt(transactionLog?.topics[3], 16);\n          // FIXME: should remove this\n          if (+tokenID > 0 && +tokenID < 10000)\n            await handleReloadNFTItemBalance.reloadNFTItemBalance(\n              process.env.REACT_APP_NFKEY_ADDRESS,\n              tokenID\n            );\n        }\n        return transactionLogList;\n      })\n      .catch((err) => {\n        new AirdropApi().logger({\n          wallet_id: user?.wallet_id,\n          type: \"ERROR\",\n          action: \"mint\",\n          description: \"HomeMint unique token\",\n          error: JSON.stringify(err),\n        });\n      });\n  };\n\n  return { mint };\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}