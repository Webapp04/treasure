{"ast":null,"code":"import _regeneratorRuntime from \"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";\nimport _createForOfIteratorHelper from \"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper.js\";\nimport _toConsumableArray from \"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/toConsumableArray.js\";\nimport _classCallCheck from \"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";\nimport _createClass from \"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/createClass.js\";\nimport _wrapAsyncGenerator from \"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/wrapAsyncGenerator.js\";\nimport _awaitAsyncGenerator from \"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/awaitAsyncGenerator.js\";\nimport _asyncGeneratorDelegate from \"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/asyncGeneratorDelegate.js\";\nimport _asyncIterator from \"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/asyncIterator.js\";\nimport varint from 'varint';\nimport { allocUnsafe } from './alloc-unsafe.js';\nimport { MessageTypes } from './message-types.js';\nvar POOL_SIZE = 10 * 1024;\nvar Encoder = /*#__PURE__*/function () {\n  function Encoder() {\n    _classCallCheck(this, Encoder);\n    this._pool = allocUnsafe(POOL_SIZE);\n    this._poolOffset = 0;\n  }\n  /**\n   * Encodes the given message and returns it and its header\n   */\n  _createClass(Encoder, [{\n    key: \"write\",\n    value: function write(msg) {\n      var pool = this._pool;\n      var offset = this._poolOffset;\n      varint.encode(msg.id << 3 | msg.type, pool, offset);\n      offset += varint.encode.bytes;\n      if ((msg.type === MessageTypes.NEW_STREAM || msg.type === MessageTypes.MESSAGE_INITIATOR || msg.type === MessageTypes.MESSAGE_RECEIVER) && msg.data != null) {\n        varint.encode(msg.data.length, pool, offset);\n      } else {\n        varint.encode(0, pool, offset);\n      }\n      offset += varint.encode.bytes;\n      var header = pool.subarray(this._poolOffset, offset);\n      if (POOL_SIZE - offset < 100) {\n        this._pool = allocUnsafe(POOL_SIZE);\n        this._poolOffset = 0;\n      } else {\n        this._poolOffset = offset;\n      }\n      if ((msg.type === MessageTypes.NEW_STREAM || msg.type === MessageTypes.MESSAGE_INITIATOR || msg.type === MessageTypes.MESSAGE_RECEIVER) && msg.data != null) {\n        return [header].concat(_toConsumableArray(msg.data instanceof Uint8Array ? [msg.data] : msg.data));\n      }\n      return [header];\n    }\n  }]);\n  return Encoder;\n}();\nvar encoder = new Encoder();\n/**\n * Encode and yield one or more messages\n */\nexport function encode(_x) {\n  return _encode.apply(this, arguments);\n}\nfunction _encode() {\n  _encode = _wrapAsyncGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee(source) {\n    var _iteratorAbruptCompletion, _didIteratorError, _iteratorError, _iterator, _step, msg, _iterator2, _step2, m;\n    return _regeneratorRuntime().wrap(function _callee$(_context) {\n      while (1) switch (_context.prev = _context.next) {\n        case 0:\n          _iteratorAbruptCompletion = false;\n          _didIteratorError = false;\n          _context.prev = 2;\n          _iterator = _asyncIterator(source);\n        case 4:\n          _context.next = 6;\n          return _awaitAsyncGenerator(_iterator.next());\n        case 6:\n          if (!(_iteratorAbruptCompletion = !(_step = _context.sent).done)) {\n            _context.next = 31;\n            break;\n          }\n          msg = _step.value;\n          if (!Array.isArray(msg)) {\n            _context.next = 27;\n            break;\n          }\n          _iterator2 = _createForOfIteratorHelper(msg);\n          _context.prev = 10;\n          _iterator2.s();\n        case 12:\n          if ((_step2 = _iterator2.n()).done) {\n            _context.next = 17;\n            break;\n          }\n          m = _step2.value;\n          return _context.delegateYield(_asyncGeneratorDelegate(_asyncIterator(encoder.write(m)), _awaitAsyncGenerator), \"t0\", 15);\n        case 15:\n          _context.next = 12;\n          break;\n        case 17:\n          _context.next = 22;\n          break;\n        case 19:\n          _context.prev = 19;\n          _context.t1 = _context[\"catch\"](10);\n          _iterator2.e(_context.t1);\n        case 22:\n          _context.prev = 22;\n          _iterator2.f();\n          return _context.finish(22);\n        case 25:\n          _context.next = 28;\n          break;\n        case 27:\n          return _context.delegateYield(_asyncGeneratorDelegate(_asyncIterator(encoder.write(msg)), _awaitAsyncGenerator), \"t2\", 28);\n        case 28:\n          _iteratorAbruptCompletion = false;\n          _context.next = 4;\n          break;\n        case 31:\n          _context.next = 37;\n          break;\n        case 33:\n          _context.prev = 33;\n          _context.t3 = _context[\"catch\"](2);\n          _didIteratorError = true;\n          _iteratorError = _context.t3;\n        case 37:\n          _context.prev = 37;\n          _context.prev = 38;\n          if (!(_iteratorAbruptCompletion && _iterator.return != null)) {\n            _context.next = 42;\n            break;\n          }\n          _context.next = 42;\n          return _awaitAsyncGenerator(_iterator.return());\n        case 42:\n          _context.prev = 42;\n          if (!_didIteratorError) {\n            _context.next = 45;\n            break;\n          }\n          throw _iteratorError;\n        case 45:\n          return _context.finish(42);\n        case 46:\n          return _context.finish(37);\n        case 47:\n        case \"end\":\n          return _context.stop();\n      }\n    }, _callee, null, [[2, 33, 37, 47], [10, 19, 22, 25], [38,, 42, 46]]);\n  }));\n  return _encode.apply(this, arguments);\n}","map":{"version":3,"names":["varint","allocUnsafe","MessageTypes","POOL_SIZE","Encoder","_classCallCheck","_pool","_poolOffset","_createClass","key","value","write","msg","pool","offset","encode","id","type","bytes","NEW_STREAM","MESSAGE_INITIATOR","MESSAGE_RECEIVER","data","length","header","subarray","concat","_toConsumableArray","Uint8Array","encoder","_x","_encode","apply","arguments","_wrapAsyncGenerator","_regeneratorRuntime","mark","_callee","source","_iteratorAbruptCompletion","_didIteratorError","_iteratorError","_iterator","_step","_iterator2","_step2","m","wrap","_callee$","_context","prev","next","_asyncIterator","_awaitAsyncGenerator","sent","done","Array","isArray","_createForOfIteratorHelper","s","n","delegateYield","_asyncGeneratorDelegate","t1","e","f","finish","t3","return","stop"],"sources":["/Users/apple/Documents/treasure/node_modules/@libp2p/mplex/src/encode.ts"],"sourcesContent":["import type { Source } from 'it-stream-types'\nimport varint from 'varint'\nimport { allocUnsafe } from './alloc-unsafe.js'\nimport { Message, MessageTypes } from './message-types.js'\n\nconst POOL_SIZE = 10 * 1024\n\nclass Encoder {\n  private _pool: Uint8Array\n  private _poolOffset: number\n\n  constructor () {\n    this._pool = allocUnsafe(POOL_SIZE)\n    this._poolOffset = 0\n  }\n\n  /**\n   * Encodes the given message and returns it and its header\n   */\n  write (msg: Message): Uint8Array[] {\n    const pool = this._pool\n    let offset = this._poolOffset\n\n    varint.encode(msg.id << 3 | msg.type, pool, offset)\n    offset += varint.encode.bytes\n\n    if ((msg.type === MessageTypes.NEW_STREAM || msg.type === MessageTypes.MESSAGE_INITIATOR || msg.type === MessageTypes.MESSAGE_RECEIVER) && msg.data != null) {\n      varint.encode(msg.data.length, pool, offset)\n    } else {\n      varint.encode(0, pool, offset)\n    }\n\n    offset += varint.encode.bytes\n\n    const header = pool.subarray(this._poolOffset, offset)\n\n    if (POOL_SIZE - offset < 100) {\n      this._pool = allocUnsafe(POOL_SIZE)\n      this._poolOffset = 0\n    } else {\n      this._poolOffset = offset\n    }\n\n    if ((msg.type === MessageTypes.NEW_STREAM || msg.type === MessageTypes.MESSAGE_INITIATOR || msg.type === MessageTypes.MESSAGE_RECEIVER) && msg.data != null) {\n      return [\n        header,\n        ...(msg.data instanceof Uint8Array ? [msg.data] : msg.data)\n      ]\n    }\n\n    return [\n      header\n    ]\n  }\n}\n\nconst encoder = new Encoder()\n\n/**\n * Encode and yield one or more messages\n */\nexport async function * encode (source: Source<Message | Message[]>) {\n  for await (const msg of source) {\n    if (Array.isArray(msg)) {\n      for (const m of msg) {\n        yield * encoder.write(m)\n      }\n    } else {\n      yield * encoder.write(msg)\n    }\n  }\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}