{"ast":null,"code":"import _objectSpread from \"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";\nimport _regeneratorRuntime from \"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";\nimport _awaitAsyncGenerator from \"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/awaitAsyncGenerator.js\";\nimport _wrapAsyncGenerator from \"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/wrapAsyncGenerator.js\";\nimport { AbortError } from './abort-error.js';\nimport { getIterator } from 'get-iterator';\n// Wrap an iterator to make it abortable, allow cleanup when aborted via onAbort\nexport function abortableSource(source, signal, options) {\n  var opts = options !== null && options !== void 0 ? options : {};\n  var iterator = getIterator(source);\n  function abortable() {\n    return _abortable.apply(this, arguments);\n  }\n  function _abortable() {\n    _abortable = _wrapAsyncGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee() {\n      var nextAbortHandler, abortHandler, result, abortMessage, abortCode, abort, isKnownAborter, p;\n      return _regeneratorRuntime().wrap(function _callee$(_context) {\n        while (1) switch (_context.prev = _context.next) {\n          case 0:\n            abortHandler = function abortHandler() {\n              if (nextAbortHandler != null) nextAbortHandler();\n            };\n            signal.addEventListener('abort', abortHandler);\n          case 2:\n            if (!true) {\n              _context.next = 32;\n              break;\n            }\n            result = void 0;\n            _context.prev = 4;\n            if (!signal.aborted) {\n              _context.next = 8;\n              break;\n            }\n            abortMessage = opts.abortMessage, abortCode = opts.abortCode;\n            throw new AbortError(abortMessage, abortCode);\n          case 8:\n            abort = new Promise(function (resolve, reject) {\n              nextAbortHandler = function nextAbortHandler() {\n                var abortMessage = opts.abortMessage,\n                  abortCode = opts.abortCode;\n                reject(new AbortError(abortMessage, abortCode));\n              };\n            }); // Race the iterator and the abort signals\n            _context.next = 11;\n            return _awaitAsyncGenerator(Promise.race([abort, iterator.next()]));\n          case 11:\n            result = _context.sent;\n            nextAbortHandler = null;\n            _context.next = 26;\n            break;\n          case 15:\n            _context.prev = 15;\n            _context.t0 = _context[\"catch\"](4);\n            signal.removeEventListener('abort', abortHandler);\n            // Might not have been aborted by a known signal\n            isKnownAborter = _context.t0.type === 'aborted' && signal.aborted;\n            if (!(isKnownAborter && opts.onAbort != null)) {\n              _context.next = 22;\n              break;\n            }\n            _context.next = 22;\n            return _awaitAsyncGenerator(opts.onAbort(source));\n          case 22:\n            // End the iterator if it is a generator\n            if (typeof iterator.return === 'function') {\n              try {\n                p = iterator.return();\n                if (p instanceof Promise) {\n                  // eslint-disable-line max-depth\n                  p.catch(function (err) {\n                    if (opts.onReturnError != null) {\n                      opts.onReturnError(err);\n                    }\n                  });\n                }\n              } catch (err) {\n                if (opts.onReturnError != null) {\n                  // eslint-disable-line max-depth\n                  opts.onReturnError(err);\n                }\n              }\n            }\n            if (!(isKnownAborter && opts.returnOnAbort === true)) {\n              _context.next = 25;\n              break;\n            }\n            return _context.abrupt(\"return\");\n          case 25:\n            throw _context.t0;\n          case 26:\n            if (!(result.done === true)) {\n              _context.next = 28;\n              break;\n            }\n            return _context.abrupt(\"break\", 32);\n          case 28:\n            _context.next = 30;\n            return result.value;\n          case 30:\n            _context.next = 2;\n            break;\n          case 32:\n            signal.removeEventListener('abort', abortHandler);\n          case 33:\n          case \"end\":\n            return _context.stop();\n        }\n      }, _callee, null, [[4, 15]]);\n    }));\n    return _abortable.apply(this, arguments);\n  }\n  return abortable();\n}\nexport function abortableSink(sink, signal, options) {\n  return function (source) {\n    return sink(abortableSource(source, signal, options));\n  };\n}\nexport function abortableDuplex(duplex, signal, options) {\n  return {\n    sink: abortableSink(duplex.sink, signal, _objectSpread(_objectSpread({}, options), {}, {\n      onAbort: undefined\n    })),\n    source: abortableSource(duplex.source, signal, options)\n  };\n}\nexport { AbortError };\nexport { abortableSink as abortableTransform };","map":{"version":3,"names":["AbortError","getIterator","abortableSource","source","signal","options","opts","iterator","abortable","_abortable","apply","arguments","_wrapAsyncGenerator","_regeneratorRuntime","mark","_callee","nextAbortHandler","abortHandler","result","abortMessage","abortCode","abort","isKnownAborter","p","wrap","_callee$","_context","prev","next","addEventListener","aborted","Promise","resolve","reject","_awaitAsyncGenerator","race","sent","t0","removeEventListener","type","onAbort","return","catch","err","onReturnError","returnOnAbort","abrupt","done","value","stop","abortableSink","sink","abortableDuplex","duplex","_objectSpread","undefined","abortableTransform"],"sources":["/Users/apple/Documents/treasure/node_modules/abortable-iterator/src/index.ts"],"sourcesContent":["import { AbortError } from './abort-error.js'\nimport { getIterator } from 'get-iterator'\nimport type { Duplex, Source, Sink } from 'it-stream-types'\n\nexport interface Options<T> {\n  onReturnError?: (err: Error) => void\n  onAbort?: (source: Source<T>) => void\n  abortMessage?: string\n  abortCode?: string\n  returnOnAbort?: boolean\n}\n\n// Wrap an iterator to make it abortable, allow cleanup when aborted via onAbort\nexport function abortableSource <T> (source: Source<T>, signal: AbortSignal, options?: Options<T>) {\n  const opts: Options<T> = options ?? {}\n  const iterator = getIterator<T>(source)\n\n  async function * abortable () {\n    let nextAbortHandler: (() => void) | null\n    const abortHandler = () => {\n      if (nextAbortHandler != null) nextAbortHandler()\n    }\n\n    signal.addEventListener('abort', abortHandler)\n\n    while (true) {\n      let result: IteratorResult<T, any>\n      try {\n        if (signal.aborted) {\n          const { abortMessage, abortCode } = opts\n          throw new AbortError(abortMessage, abortCode)\n        }\n\n        const abort = new Promise<any>((resolve, reject) => { // eslint-disable-line no-loop-func\n          nextAbortHandler = () => {\n            const { abortMessage, abortCode } = opts\n            reject(new AbortError(abortMessage, abortCode))\n          }\n        })\n\n        // Race the iterator and the abort signals\n        result = await Promise.race([abort, iterator.next()])\n        nextAbortHandler = null\n      } catch (err: any) {\n        signal.removeEventListener('abort', abortHandler)\n\n        // Might not have been aborted by a known signal\n        const isKnownAborter = err.type === 'aborted' && signal.aborted\n\n        if (isKnownAborter && (opts.onAbort != null)) {\n          // Do any custom abort handling for the iterator\n          await opts.onAbort(source)\n        }\n\n        // End the iterator if it is a generator\n        if (typeof iterator.return === 'function') {\n          try {\n            const p = iterator.return()\n\n            if (p instanceof Promise) { // eslint-disable-line max-depth\n              p.catch(err => {\n                if (opts.onReturnError != null) {\n                  opts.onReturnError(err)\n                }\n              })\n            }\n          } catch (err: any) {\n            if (opts.onReturnError != null) { // eslint-disable-line max-depth\n              opts.onReturnError(err)\n            }\n          }\n        }\n\n        if (isKnownAborter && opts.returnOnAbort === true) {\n          return\n        }\n\n        throw err\n      }\n\n      if (result.done === true) {\n        break\n      }\n\n      yield result.value\n    }\n\n    signal.removeEventListener('abort', abortHandler)\n  }\n\n  return abortable()\n}\n\nexport function abortableSink <T, R> (sink: Sink<T, R>, signal: AbortSignal, options?: Options<T>): Sink<T, R> {\n  return (source: Source<T>) => sink(abortableSource(source, signal, options))\n}\n\nexport function abortableDuplex <TSource, TSink = TSource, RSink = Promise<void>> (duplex: Duplex<TSource, TSink, RSink>, signal: AbortSignal, options?: Options<TSource>) {\n  return {\n    sink: abortableSink(duplex.sink, signal, {\n      ...options,\n      onAbort: undefined\n    }),\n    source: abortableSource(duplex.source, signal, options)\n  }\n}\n\nexport { AbortError }\nexport { abortableSink as abortableTransform }\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}