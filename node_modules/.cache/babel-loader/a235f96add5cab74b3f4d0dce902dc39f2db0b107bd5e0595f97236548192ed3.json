{"ast":null,"code":"var _classCallCheck = require(\"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/classCallCheck.js\").default;\nvar _createClass = require(\"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/createClass.js\").default;\nvar _inherits = require(\"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/inherits.js\").default;\nvar _createSuper = require(\"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/createSuper.js\").default;\nvar RateLimiterStoreAbstract = require('./RateLimiterStoreAbstract');\nvar RateLimiterRes = require('./RateLimiterRes');\nvar RateLimiterMemcache = /*#__PURE__*/function (_RateLimiterStoreAbst) {\n  \"use strict\";\n\n  _inherits(RateLimiterMemcache, _RateLimiterStoreAbst);\n  var _super = _createSuper(RateLimiterMemcache);\n  /**\n   *\n   * @param {Object} opts\n   * Defaults {\n   *   ... see other in RateLimiterStoreAbstract\n   *\n   *   storeClient: memcacheClient\n   * }\n   */\n  function RateLimiterMemcache(opts) {\n    var _this;\n    _classCallCheck(this, RateLimiterMemcache);\n    _this = _super.call(this, opts);\n    _this.client = opts.storeClient;\n    return _this;\n  }\n  _createClass(RateLimiterMemcache, [{\n    key: \"_getRateLimiterRes\",\n    value: function _getRateLimiterRes(rlKey, changedPoints, result) {\n      var res = new RateLimiterRes();\n      res.consumedPoints = parseInt(result.consumedPoints);\n      res.isFirstInDuration = result.consumedPoints === changedPoints;\n      res.remainingPoints = Math.max(this.points - res.consumedPoints, 0);\n      res.msBeforeNext = result.msBeforeNext;\n      return res;\n    }\n  }, {\n    key: \"_upsert\",\n    value: function _upsert(rlKey, points, msDuration) {\n      var _this2 = this;\n      var forceExpire = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : false;\n      var options = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : {};\n      return new Promise(function (resolve, reject) {\n        var nowMs = Date.now();\n        var secDuration = Math.floor(msDuration / 1000);\n        if (forceExpire) {\n          _this2.client.set(rlKey, points, secDuration, function (err) {\n            if (!err) {\n              _this2.client.set(\"\".concat(rlKey, \"_expire\"), secDuration > 0 ? nowMs + secDuration * 1000 : -1, secDuration, function () {\n                var res = {\n                  consumedPoints: points,\n                  msBeforeNext: secDuration > 0 ? secDuration * 1000 : -1\n                };\n                resolve(res);\n              });\n            } else {\n              reject(err);\n            }\n          });\n        } else {\n          _this2.client.incr(rlKey, points, function (err, consumedPoints) {\n            if (err || consumedPoints === false) {\n              _this2.client.add(rlKey, points, secDuration, function (errAddKey, createdNew) {\n                if (errAddKey || !createdNew) {\n                  // Try to upsert again in case of race condition\n                  if (typeof options.attemptNumber === 'undefined' || options.attemptNumber < 3) {\n                    var nextOptions = Object.assign({}, options);\n                    nextOptions.attemptNumber = nextOptions.attemptNumber ? nextOptions.attemptNumber + 1 : 1;\n                    _this2._upsert(rlKey, points, msDuration, forceExpire, nextOptions).then(function (resUpsert) {\n                      return resolve(resUpsert);\n                    }).catch(function (errUpsert) {\n                      return reject(errUpsert);\n                    });\n                  } else {\n                    reject(new Error('Can not add key'));\n                  }\n                } else {\n                  _this2.client.add(\"\".concat(rlKey, \"_expire\"), secDuration > 0 ? nowMs + secDuration * 1000 : -1, secDuration, function () {\n                    var res = {\n                      consumedPoints: points,\n                      msBeforeNext: secDuration > 0 ? secDuration * 1000 : -1\n                    };\n                    resolve(res);\n                  });\n                }\n              });\n            } else {\n              _this2.client.get(\"\".concat(rlKey, \"_expire\"), function (errGetExpire, resGetExpireMs) {\n                if (errGetExpire) {\n                  reject(errGetExpire);\n                } else {\n                  var expireMs = resGetExpireMs === false ? 0 : resGetExpireMs;\n                  var res = {\n                    consumedPoints: consumedPoints,\n                    msBeforeNext: expireMs >= 0 ? Math.max(expireMs - nowMs, 0) : -1\n                  };\n                  resolve(res);\n                }\n              });\n            }\n          });\n        }\n      });\n    }\n  }, {\n    key: \"_get\",\n    value: function _get(rlKey) {\n      var _this3 = this;\n      return new Promise(function (resolve, reject) {\n        var nowMs = Date.now();\n        _this3.client.get(rlKey, function (err, consumedPoints) {\n          if (!consumedPoints) {\n            resolve(null);\n          } else {\n            _this3.client.get(\"\".concat(rlKey, \"_expire\"), function (errGetExpire, resGetExpireMs) {\n              if (errGetExpire) {\n                reject(errGetExpire);\n              } else {\n                var expireMs = resGetExpireMs === false ? 0 : resGetExpireMs;\n                var res = {\n                  consumedPoints: consumedPoints,\n                  msBeforeNext: expireMs >= 0 ? Math.max(expireMs - nowMs, 0) : -1\n                };\n                resolve(res);\n              }\n            });\n          }\n        });\n      });\n    }\n  }, {\n    key: \"_delete\",\n    value: function _delete(rlKey) {\n      var _this4 = this;\n      return new Promise(function (resolve, reject) {\n        _this4.client.del(rlKey, function (err, res) {\n          if (err) {\n            reject(err);\n          } else if (res === false) {\n            resolve(res);\n          } else {\n            _this4.client.del(\"\".concat(rlKey, \"_expire\"), function (errDelExpire) {\n              if (errDelExpire) {\n                reject(errDelExpire);\n              } else {\n                resolve(res);\n              }\n            });\n          }\n        });\n      });\n    }\n  }]);\n  return RateLimiterMemcache;\n}(RateLimiterStoreAbstract);\nmodule.exports = RateLimiterMemcache;","map":{"version":3,"names":["RateLimiterStoreAbstract","require","RateLimiterRes","RateLimiterMemcache","_RateLimiterStoreAbst","_inherits","_super","_createSuper","opts","_this","_classCallCheck","call","client","storeClient","_createClass","key","value","_getRateLimiterRes","rlKey","changedPoints","result","res","consumedPoints","parseInt","isFirstInDuration","remainingPoints","Math","max","points","msBeforeNext","_upsert","msDuration","_this2","forceExpire","arguments","length","undefined","options","Promise","resolve","reject","nowMs","Date","now","secDuration","floor","set","err","concat","incr","add","errAddKey","createdNew","attemptNumber","nextOptions","Object","assign","then","resUpsert","catch","errUpsert","Error","get","errGetExpire","resGetExpireMs","expireMs","_get","_this3","_delete","_this4","del","errDelExpire","module","exports"],"sources":["/Users/apple/Documents/treasure/node_modules/rate-limiter-flexible/lib/RateLimiterMemcache.js"],"sourcesContent":["const RateLimiterStoreAbstract = require('./RateLimiterStoreAbstract');\nconst RateLimiterRes = require('./RateLimiterRes');\n\nclass RateLimiterMemcache extends RateLimiterStoreAbstract {\n  /**\n   *\n   * @param {Object} opts\n   * Defaults {\n   *   ... see other in RateLimiterStoreAbstract\n   *\n   *   storeClient: memcacheClient\n   * }\n   */\n  constructor(opts) {\n    super(opts);\n\n    this.client = opts.storeClient;\n  }\n\n  _getRateLimiterRes(rlKey, changedPoints, result) {\n    const res = new RateLimiterRes();\n    res.consumedPoints = parseInt(result.consumedPoints);\n    res.isFirstInDuration = result.consumedPoints === changedPoints;\n    res.remainingPoints = Math.max(this.points - res.consumedPoints, 0);\n    res.msBeforeNext = result.msBeforeNext;\n\n    return res;\n  }\n\n  _upsert(rlKey, points, msDuration, forceExpire = false, options = {}) {\n    return new Promise((resolve, reject) => {\n      const nowMs = Date.now();\n      const secDuration = Math.floor(msDuration / 1000);\n\n      if (forceExpire) {\n        this.client.set(rlKey, points, secDuration, (err) => {\n          if (!err) {\n            this.client.set(\n              `${rlKey}_expire`,\n              secDuration > 0 ? nowMs + (secDuration * 1000) : -1,\n              secDuration,\n              () => {\n                const res = {\n                  consumedPoints: points,\n                  msBeforeNext: secDuration > 0 ? secDuration * 1000 : -1,\n                };\n                resolve(res);\n              }\n            );\n          } else {\n            reject(err);\n          }\n        });\n      } else {\n        this.client.incr(rlKey, points, (err, consumedPoints) => {\n          if (err || consumedPoints === false) {\n            this.client.add(rlKey, points, secDuration, (errAddKey, createdNew) => {\n              if (errAddKey || !createdNew) {\n                // Try to upsert again in case of race condition\n                if (typeof options.attemptNumber === 'undefined' || options.attemptNumber < 3) {\n                  const nextOptions = Object.assign({}, options);\n                  nextOptions.attemptNumber = nextOptions.attemptNumber ? (nextOptions.attemptNumber + 1) : 1;\n\n                  this._upsert(rlKey, points, msDuration, forceExpire, nextOptions)\n                    .then(resUpsert => resolve(resUpsert))\n                    .catch(errUpsert => reject(errUpsert));\n                } else {\n                  reject(new Error('Can not add key'));\n                }\n              } else {\n                this.client.add(\n                  `${rlKey}_expire`,\n                  secDuration > 0 ? nowMs + (secDuration * 1000) : -1,\n                  secDuration,\n                  () => {\n                    const res = {\n                      consumedPoints: points,\n                      msBeforeNext: secDuration > 0 ? secDuration * 1000 : -1,\n                    };\n                    resolve(res);\n                  }\n                );\n              }\n            });\n          } else {\n            this.client.get(`${rlKey}_expire`, (errGetExpire, resGetExpireMs) => {\n              if (errGetExpire) {\n                reject(errGetExpire);\n              } else {\n                const expireMs = resGetExpireMs === false ? 0 : resGetExpireMs;\n                const res = {\n                  consumedPoints,\n                  msBeforeNext: expireMs >= 0 ? Math.max(expireMs - nowMs, 0) : -1,\n                };\n                resolve(res);\n              }\n            });\n          }\n        });\n      }\n    });\n  }\n\n  _get(rlKey) {\n    return new Promise((resolve, reject) => {\n      const nowMs = Date.now();\n\n      this.client.get(rlKey, (err, consumedPoints) => {\n        if (!consumedPoints) {\n          resolve(null);\n        } else {\n          this.client.get(`${rlKey}_expire`, (errGetExpire, resGetExpireMs) => {\n            if (errGetExpire) {\n              reject(errGetExpire);\n            } else {\n              const expireMs = resGetExpireMs === false ? 0 : resGetExpireMs;\n              const res = {\n                consumedPoints,\n                msBeforeNext: expireMs >= 0 ? Math.max(expireMs - nowMs, 0) : -1,\n              };\n              resolve(res);\n            }\n          });\n        }\n      });\n    });\n  }\n\n  _delete(rlKey) {\n    return new Promise((resolve, reject) => {\n      this.client.del(rlKey, (err, res) => {\n        if (err) {\n          reject(err);\n        } else if (res === false) {\n          resolve(res);\n        } else {\n          this.client.del(`${rlKey}_expire`, (errDelExpire) => {\n            if (errDelExpire) {\n              reject(errDelExpire);\n            } else {\n              resolve(res);\n            }\n          });\n        }\n      });\n    });\n  }\n}\n\nmodule.exports = RateLimiterMemcache;\n"],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}