{"ast":null,"code":"import _createForOfIteratorHelper from \"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper.js\";\nimport _classCallCheck from \"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";\nimport _createClass from \"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/createClass.js\";\nimport _inherits from \"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/inherits.js\";\nimport _createSuper from \"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/createSuper.js\";\nimport { EventEmitter } from 'events';\nimport { Stat } from './stat.js';\nimport { trackedMap } from '@libp2p/tracked-map';\n\n/**\n * @typedef {import('multiformats').CID} CID\n * @typedef {import('@libp2p/interface-peer-id').PeerId} PeerId\n */\n\n/**\n * @typedef {[number, number, number]} AverageIntervals\n */\nvar defaultOptions = {\n  enabled: false,\n  computeThrottleTimeout: 1000,\n  computeThrottleMaxQueueSize: 1000,\n  movingAverageIntervals: /** @type {AverageIntervals} */[60 * 1000,\n  // 1 minute\n  5 * 60 * 1000,\n  // 5 minutes\n  15 * 60 * 1000 // 15 minutes\n  ]\n};\n\nexport var Stats = /*#__PURE__*/function (_EventEmitter) {\n  _inherits(Stats, _EventEmitter);\n  var _super = _createSuper(Stats);\n  /**\n   * @param {import('libp2p').Libp2p} libp2p\n   * @param {string[]} [initialCounters]\n   * @param {object} _options\n   * @param {boolean} _options.enabled\n   * @param {number} _options.computeThrottleTimeout\n   * @param {number} _options.computeThrottleMaxQueueSize\n   */\n  function Stats(libp2p) {\n    var _this;\n    var initialCounters = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];\n    var _options = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : defaultOptions;\n    _classCallCheck(this, Stats);\n    _this = _super.call(this);\n    var options = Object.assign({}, defaultOptions, _options);\n    if (typeof options.computeThrottleTimeout !== 'number') {\n      throw new Error('need computeThrottleTimeout');\n    }\n    if (typeof options.computeThrottleMaxQueueSize !== 'number') {\n      throw new Error('need computeThrottleMaxQueueSize');\n    }\n    _this._initialCounters = initialCounters;\n    _this._options = options;\n    _this._enabled = _this._options.enabled;\n    _this._global = new Stat(initialCounters, options);\n    _this._global.on('update', function (stats) {\n      return _this.emit('update', stats);\n    });\n\n    /** @type {Map<string, Stat>} */\n    _this._peers = trackedMap({\n      system: 'ipfs',\n      component: 'bitswap',\n      metric: 'stats-peers',\n      metrics: libp2p.metrics\n    });\n    return _this;\n  }\n  _createClass(Stats, [{\n    key: \"enable\",\n    value: function enable() {\n      this._enabled = true;\n      this._options.enabled = true;\n      this._global.enable();\n    }\n  }, {\n    key: \"disable\",\n    value: function disable() {\n      this._enabled = false;\n      this._options.enabled = false;\n      this._global.disable();\n    }\n  }, {\n    key: \"stop\",\n    value: function stop() {\n      this._enabled = false;\n      this._global.stop();\n      var _iterator = _createForOfIteratorHelper(this._peers),\n        _step;\n      try {\n        for (_iterator.s(); !(_step = _iterator.n()).done;) {\n          var peerStat = _step.value;\n          peerStat[1].stop();\n        }\n      } catch (err) {\n        _iterator.e(err);\n      } finally {\n        _iterator.f();\n      }\n    }\n  }, {\n    key: \"snapshot\",\n    get: function get() {\n      return this._global.snapshot;\n    }\n  }, {\n    key: \"movingAverages\",\n    get: function get() {\n      return this._global.movingAverages;\n    }\n\n    /**\n     * @param {PeerId|string} peerId\n     * @returns {Stat|undefined}\n     */\n  }, {\n    key: \"forPeer\",\n    value: function forPeer(peerId) {\n      var peerIdStr = typeof peerId !== 'string' && peerId.toString ? peerId.toString() : \"\".concat(peerId);\n      return this._peers.get(peerIdStr);\n    }\n\n    /**\n     *\n     * @param {string|null} peer\n     * @param {string} counter\n     * @param {number} inc\n     */\n  }, {\n    key: \"push\",\n    value: function push(peer, counter, inc) {\n      if (this._enabled) {\n        this._global.push(counter, inc);\n        if (peer) {\n          var peerStats = this._peers.get(peer);\n          if (!peerStats) {\n            peerStats = new Stat(this._initialCounters, this._options);\n            this._peers.set(peer, peerStats);\n          }\n          peerStats.push(counter, inc);\n        }\n      }\n    }\n\n    /**\n     * @param {PeerId} peer\n     */\n  }, {\n    key: \"disconnected\",\n    value: function disconnected(peer) {\n      var peerId = peer.toString();\n      var peerStats = this._peers.get(peerId);\n      if (peerStats) {\n        peerStats.stop();\n        this._peers.delete(peerId);\n      }\n    }\n  }]);\n  return Stats;\n}(EventEmitter);","map":{"version":3,"names":["EventEmitter","Stat","trackedMap","defaultOptions","enabled","computeThrottleTimeout","computeThrottleMaxQueueSize","movingAverageIntervals","Stats","_EventEmitter","_inherits","_super","_createSuper","libp2p","_this","initialCounters","arguments","length","undefined","_options","_classCallCheck","call","options","Object","assign","Error","_initialCounters","_enabled","_global","on","stats","emit","_peers","system","component","metric","metrics","_createClass","key","value","enable","disable","stop","_iterator","_createForOfIteratorHelper","_step","s","n","done","peerStat","err","e","f","get","snapshot","movingAverages","forPeer","peerId","peerIdStr","toString","concat","push","peer","counter","inc","peerStats","set","disconnected","delete"],"sources":["/Users/apple/Documents/treasure/node_modules/ipfs-bitswap/src/stats/index.js"],"sourcesContent":["import { EventEmitter } from 'events'\nimport { Stat } from './stat.js'\nimport { trackedMap } from '@libp2p/tracked-map'\n\n/**\n * @typedef {import('multiformats').CID} CID\n * @typedef {import('@libp2p/interface-peer-id').PeerId} PeerId\n */\n\n/**\n * @typedef {[number, number, number]} AverageIntervals\n */\nconst defaultOptions = {\n  enabled: false,\n  computeThrottleTimeout: 1000,\n  computeThrottleMaxQueueSize: 1000,\n  movingAverageIntervals: /** @type {AverageIntervals} */ ([\n    60 * 1000, // 1 minute\n    5 * 60 * 1000, // 5 minutes\n    15 * 60 * 1000 // 15 minutes\n  ])\n}\n\nexport class Stats extends EventEmitter {\n  /**\n   * @param {import('libp2p').Libp2p} libp2p\n   * @param {string[]} [initialCounters]\n   * @param {object} _options\n   * @param {boolean} _options.enabled\n   * @param {number} _options.computeThrottleTimeout\n   * @param {number} _options.computeThrottleMaxQueueSize\n   */\n  constructor (libp2p, initialCounters = [], _options = defaultOptions) {\n    super()\n\n    const options = Object.assign({}, defaultOptions, _options)\n\n    if (typeof options.computeThrottleTimeout !== 'number') {\n      throw new Error('need computeThrottleTimeout')\n    }\n\n    if (typeof options.computeThrottleMaxQueueSize !== 'number') {\n      throw new Error('need computeThrottleMaxQueueSize')\n    }\n\n    this._initialCounters = initialCounters\n    this._options = options\n    this._enabled = this._options.enabled\n\n    this._global = new Stat(initialCounters, options)\n    this._global.on('update', (stats) => this.emit('update', stats))\n\n    /** @type {Map<string, Stat>} */\n    this._peers = trackedMap({\n      system: 'ipfs',\n      component: 'bitswap',\n      metric: 'stats-peers',\n      metrics: libp2p.metrics\n    })\n  }\n\n  enable () {\n    this._enabled = true\n    this._options.enabled = true\n    this._global.enable()\n  }\n\n  disable () {\n    this._enabled = false\n    this._options.enabled = false\n    this._global.disable()\n  }\n\n  stop () {\n    this._enabled = false\n    this._global.stop()\n    for (const peerStat of this._peers) {\n      peerStat[1].stop()\n    }\n  }\n\n  get snapshot () {\n    return this._global.snapshot\n  }\n\n  get movingAverages () {\n    return this._global.movingAverages\n  }\n\n  /**\n   * @param {PeerId|string} peerId\n   * @returns {Stat|undefined}\n   */\n  forPeer (peerId) {\n    const peerIdStr = (typeof peerId !== 'string' && peerId.toString)\n      ? peerId.toString()\n      : `${peerId}`\n\n    return this._peers.get(peerIdStr)\n  }\n\n  /**\n   *\n   * @param {string|null} peer\n   * @param {string} counter\n   * @param {number} inc\n   */\n  push (peer, counter, inc) {\n    if (this._enabled) {\n      this._global.push(counter, inc)\n\n      if (peer) {\n        let peerStats = this._peers.get(peer)\n        if (!peerStats) {\n          peerStats = new Stat(this._initialCounters, this._options)\n          this._peers.set(peer, peerStats)\n        }\n\n        peerStats.push(counter, inc)\n      }\n    }\n  }\n\n  /**\n   * @param {PeerId} peer\n   */\n  disconnected (peer) {\n    const peerId = peer.toString()\n    const peerStats = this._peers.get(peerId)\n    if (peerStats) {\n      peerStats.stop()\n      this._peers.delete(peerId)\n    }\n  }\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}