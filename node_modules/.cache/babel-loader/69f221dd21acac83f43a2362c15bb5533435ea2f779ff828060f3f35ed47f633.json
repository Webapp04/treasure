{"ast":null,"code":"import _regeneratorRuntime from \"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";\nimport _asyncToGenerator from \"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport _objectSpread from \"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";\nimport _classCallCheck from \"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";\nimport _createClass from \"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/createClass.js\";\nimport _inherits from \"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/inherits.js\";\nimport _createSuper from \"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/createSuper.js\";\nimport { WebRTCPeer } from './peer.js';\nimport { WebRTCHandshake } from './handshake.js';\nimport randombytes from 'iso-random-stream/src/random.js';\nimport { toString as uint8ArrayToString } from 'uint8arrays/to-string';\nimport { pEvent } from 'p-event';\nimport delay from 'delay';\nimport { CustomEvent } from '@libp2p/interfaces/events';\nimport { logger } from '@libp2p/logger';\nvar log = logger('libp2p:webrtc-peer:initator');\nvar ICECOMPLETE_TIMEOUT = 1000;\nexport var WebRTCInitiator = /*#__PURE__*/function (_WebRTCPeer) {\n  _inherits(WebRTCInitiator, _WebRTCPeer);\n  var _super = _createSuper(WebRTCInitiator);\n  function WebRTCInitiator() {\n    var _opts$dataChannelLabe;\n    var _this;\n    var opts = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n    _classCallCheck(this, WebRTCInitiator);\n    _this = _super.call(this, _objectSpread(_objectSpread({}, opts), {}, {\n      logPrefix: 'initiator'\n    }));\n    _this.handleDataChannelEvent({\n      channel: _this.peerConnection.createDataChannel((_opts$dataChannelLabe = opts.dataChannelLabel) !== null && _opts$dataChannelLabe !== void 0 ? _opts$dataChannelLabe : uint8ArrayToString(randombytes(20), 'hex').slice(0, 7), opts.dataChannelInit)\n    });\n    _this.handshake = new WebRTCInitiatorHandshake({\n      log: _this.log,\n      peerConnection: _this.peerConnection,\n      wrtc: _this.wrtc,\n      offerOptions: opts.offerOptions\n    });\n    _this.handshake.addEventListener('signal', function (event) {\n      _this.dispatchEvent(new CustomEvent('signal', {\n        detail: event.detail\n      }));\n    });\n    return _this;\n  }\n  _createClass(WebRTCInitiator, [{\n    key: \"handleSignal\",\n    value: function handleSignal(signal) {\n      var _this2 = this;\n      this.handshake.handleSignal(signal).catch(function (err) {\n        _this2.log('error handling signal %o %o', signal, err);\n      });\n    }\n  }]);\n  return WebRTCInitiator;\n}(WebRTCPeer);\nvar WebRTCInitiatorHandshake = /*#__PURE__*/function (_WebRTCHandshake) {\n  _inherits(WebRTCInitiatorHandshake, _WebRTCHandshake);\n  var _super2 = _createSuper(WebRTCInitiatorHandshake);\n  function WebRTCInitiatorHandshake(options) {\n    var _this3;\n    _classCallCheck(this, WebRTCInitiatorHandshake);\n    _this3 = _super2.call(this, options);\n    _this3.options = options;\n    _this3.status = 'idle';\n    _this3.peerConnection.addEventListener('icecandidate', function (event) {\n      if (event.candidate == null) {\n        return;\n      }\n      var signal = {\n        type: 'candidate',\n        candidate: {\n          candidate: event.candidate.candidate,\n          sdpMLineIndex: event.candidate.sdpMLineIndex,\n          sdpMid: event.candidate.sdpMid\n        }\n      };\n      log.trace('create candidate', signal);\n      _this3.dispatchEvent(new CustomEvent('signal', {\n        detail: signal\n      }));\n      _this3.dispatchEvent(new CustomEvent('ice-candidate'));\n    });\n    return _this3;\n  }\n  _createClass(WebRTCInitiatorHandshake, [{\n    key: \"handleRenegotiate\",\n    value: function () {\n      var _handleRenegotiate = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee() {\n        var _this$peerConnection$;\n        var offer;\n        return _regeneratorRuntime().wrap(function _callee$(_context) {\n          while (1) switch (_context.prev = _context.next) {\n            case 0:\n              if (!(this.status === 'negotiating')) {\n                _context.next = 3;\n                break;\n              }\n              this.log('already negotiating, queueing');\n              return _context.abrupt(\"return\");\n            case 3:\n              this.status = 'negotiating';\n              _context.next = 6;\n              return this.peerConnection.createOffer(this.options.offerOptions);\n            case 6:\n              offer = _context.sent;\n              _context.next = 9;\n              return this.peerConnection.setLocalDescription(offer);\n            case 9:\n              _context.next = 11;\n              return pEvent(this, 'ice-candidate');\n            case 11:\n              _context.next = 13;\n              return delay(ICECOMPLETE_TIMEOUT);\n            case 13:\n              log.trace('renegotiate', this.peerConnection.localDescription);\n              this.dispatchEvent(new CustomEvent('signal', {\n                detail: (_this$peerConnection$ = this.peerConnection.localDescription) !== null && _this$peerConnection$ !== void 0 ? _this$peerConnection$ : offer\n              }));\n            case 15:\n            case \"end\":\n              return _context.stop();\n          }\n        }, _callee, this);\n      }));\n      function handleRenegotiate() {\n        return _handleRenegotiate.apply(this, arguments);\n      }\n      return handleRenegotiate;\n    }()\n  }, {\n    key: \"handleAnswer\",\n    value: function () {\n      var _handleAnswer = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee2(signal) {\n        return _regeneratorRuntime().wrap(function _callee2$(_context2) {\n          while (1) switch (_context2.prev = _context2.next) {\n            case 0:\n              log.trace('handle answer', signal);\n              _context2.next = 3;\n              return this.peerConnection.setRemoteDescription(new this.wrtc.RTCSessionDescription(signal));\n            case 3:\n              this.status = 'idle';\n            case 4:\n            case \"end\":\n              return _context2.stop();\n          }\n        }, _callee2, this);\n      }));\n      function handleAnswer(_x) {\n        return _handleAnswer.apply(this, arguments);\n      }\n      return handleAnswer;\n    }()\n  }]);\n  return WebRTCInitiatorHandshake;\n}(WebRTCHandshake);","map":{"version":3,"names":["WebRTCPeer","WebRTCHandshake","randombytes","toString","uint8ArrayToString","pEvent","delay","CustomEvent","logger","log","ICECOMPLETE_TIMEOUT","WebRTCInitiator","_WebRTCPeer","_inherits","_super","_createSuper","_opts$dataChannelLabe","_this","opts","arguments","length","undefined","_classCallCheck","call","_objectSpread","logPrefix","handleDataChannelEvent","channel","peerConnection","createDataChannel","dataChannelLabel","slice","dataChannelInit","handshake","WebRTCInitiatorHandshake","wrtc","offerOptions","addEventListener","event","dispatchEvent","detail","_createClass","key","value","handleSignal","signal","_this2","catch","err","_WebRTCHandshake","_super2","options","_this3","status","candidate","type","sdpMLineIndex","sdpMid","trace","_handleRenegotiate","_asyncToGenerator","_regeneratorRuntime","mark","_callee","_this$peerConnection$","offer","wrap","_callee$","_context","prev","next","abrupt","createOffer","sent","setLocalDescription","localDescription","stop","handleRenegotiate","apply","_handleAnswer","_callee2","_callee2$","_context2","setRemoteDescription","RTCSessionDescription","handleAnswer","_x"],"sources":["/Users/apple/Documents/treasure/node_modules/@libp2p/webrtc-peer/src/initiator.ts"],"sourcesContent":["import { WebRTCPeer } from './peer.js'\nimport { WebRTCHandshake } from './handshake.js'\nimport randombytes from 'iso-random-stream/src/random.js'\nimport { toString as uint8ArrayToString } from 'uint8arrays/to-string'\nimport { pEvent } from 'p-event'\nimport delay from 'delay'\nimport { CustomEvent } from '@libp2p/interfaces/events'\nimport { logger } from '@libp2p/logger'\nimport type { WebRTCHandshakeOptions } from './handshake.js'\nimport type { WebRTCInitiatorInit, AnswerSignal, Signal } from './index.js'\n\nconst log = logger('libp2p:webrtc-peer:initator')\n\nconst ICECOMPLETE_TIMEOUT = 1000\n\nexport class WebRTCInitiator extends WebRTCPeer {\n  private readonly handshake: WebRTCInitiatorHandshake\n\n  constructor (opts: WebRTCInitiatorInit = {}) {\n    super({\n      ...opts,\n      logPrefix: 'initiator'\n    })\n\n    this.handleDataChannelEvent({\n      channel: this.peerConnection.createDataChannel(\n        opts.dataChannelLabel ?? uint8ArrayToString(randombytes(20), 'hex').slice(0, 7),\n        opts.dataChannelInit\n      )\n    })\n\n    this.handshake = new WebRTCInitiatorHandshake({\n      log: this.log,\n      peerConnection: this.peerConnection,\n      wrtc: this.wrtc,\n      offerOptions: opts.offerOptions\n    })\n    this.handshake.addEventListener('signal', event => {\n      this.dispatchEvent(new CustomEvent('signal', { detail: event.detail }))\n    })\n  }\n\n  handleSignal (signal: Signal) {\n    this.handshake.handleSignal(signal).catch(err => {\n      this.log('error handling signal %o %o', signal, err)\n    })\n  }\n}\n\ninterface WebRTCInitiatorHandshakeOptions extends WebRTCHandshakeOptions {\n  offerOptions?: RTCOfferOptions\n}\n\nclass WebRTCInitiatorHandshake extends WebRTCHandshake {\n  private readonly options: WebRTCInitiatorHandshakeOptions\n\n  constructor (options: WebRTCInitiatorHandshakeOptions) {\n    super(options)\n\n    this.options = options\n    this.status = 'idle'\n\n    this.peerConnection.addEventListener('icecandidate', (event) => {\n      if (event.candidate == null) {\n        return\n      }\n\n      const signal = {\n        type: 'candidate',\n        candidate: {\n          candidate: event.candidate.candidate,\n          sdpMLineIndex: event.candidate.sdpMLineIndex,\n          sdpMid: event.candidate.sdpMid\n        }\n      }\n\n      log.trace('create candidate', signal)\n\n      this.dispatchEvent(new CustomEvent('signal', {\n        detail: signal\n      }))\n      this.dispatchEvent(new CustomEvent('ice-candidate'))\n    })\n  }\n\n  async handleRenegotiate () {\n    if (this.status === 'negotiating') {\n      this.log('already negotiating, queueing')\n      return\n    }\n\n    this.status = 'negotiating'\n\n    const offer = await this.peerConnection.createOffer(this.options.offerOptions)\n\n    await this.peerConnection.setLocalDescription(offer)\n\n    // wait for at least one candidate before sending the offer\n    await pEvent(this, 'ice-candidate')\n    await delay(ICECOMPLETE_TIMEOUT)\n\n    log.trace('renegotiate', this.peerConnection.localDescription)\n\n    this.dispatchEvent(new CustomEvent('signal', {\n      detail: this.peerConnection.localDescription ?? offer\n    }))\n  }\n\n  async handleAnswer (signal: AnswerSignal) {\n    log.trace('handle answer', signal)\n\n    await this.peerConnection.setRemoteDescription(new this.wrtc.RTCSessionDescription(signal))\n    this.status = 'idle'\n  }\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}