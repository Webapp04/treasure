{"ast":null,"code":"import _regeneratorRuntime from\"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";import _asyncToGenerator from\"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _objectSpread from\"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import _toConsumableArray from\"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/toConsumableArray.js\";import TokenApi from\"../../api/TokenApi\";import EventApi from\"../../api/EventApi\";import{nowUnix,sleep}from\"../../utils\";// TODO: this is not required, should moved to useHandleNFT\nexport default function useHandleToken(){var createToken=function createToken(data){return new TokenApi().createToken(data);};var _tierDuration=function _tierDuration(tier){return(8-tier)*60;// PRODUCTION: this should be a day not 60s\n};var computeTier=function computeTier(nfkey){var updatedTime=nfkey===null||nfkey===void 0?void 0:nfkey.tierUpdatedTime;for(var i=nfkey===null||nfkey===void 0?void 0:nfkey.tierTresr;i>0;i--){if(nowUnix()<updatedTime+_tierDuration(i)){return i;}updatedTime+=_tierDuration(i);}return 0;};// TODO: this should be refactored, computeTier, getComputeTier two function\nvar getComputeTier=function getComputeTier(selectedToken){var tierTresr=computeTier(selectedToken);return[].concat(_toConsumableArray(selectedToken),[tierTresr]);};var getTierUpdatedToken=function getTierUpdatedToken(_token){var token=_objectSpread({},_token);var updatedTime=_token===null||_token===void 0?void 0:_token.tierUpdatedTime;var currentTime=nowUnix();var i=0;for(i=token===null||token===void 0?void 0:token.tierTresr;i>0;i--){if(currentTime<updatedTime+_tierDuration(i)){updatedTime+=_tierDuration(i);break;}updatedTime+=_tierDuration(i);}token.tierTresr=i;token.tierExpireTime=updatedTime;return token;};var getTokenList=function getTokenList(userAddress){return new TokenApi().getTokenList(userAddress).then(function(res){var _res$data;return res!==null&&res!==void 0&&res.status?(res===null||res===void 0?void 0:(_res$data=res.data)===null||_res$data===void 0?void 0:_res$data.data.map(function(nfkey){nfkey=getTierUpdatedToken(nfkey);return nfkey;}))||[]:[];});};var checkToken=function checkToken(tokenID){return new TokenApi().checkToken({tokenID:tokenID}).then(function(res){return res!==null&&res!==void 0&&res.status?getTierUpdatedToken(res===null||res===void 0?void 0:res.data):null;});};var updateUserTokenList=function updateUserTokenList(contractAddress){var count=arguments.length>1&&arguments[1]!==undefined?arguments[1]:3;return new TokenApi().updateUserTokenList({contractAddress:contractAddress}).then(function(res){return res!==null&&res!==void 0&&res.status?res===null||res===void 0?void 0:res.data:null;}).catch(function(){return count?updateUserTokenList(contractAddress,count-1):null;});};var checkTxEventSingle=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee(txHash,eventName){var res;return _regeneratorRuntime().wrap(function _callee$(_context){while(1)switch(_context.prev=_context.next){case 0:_context.next=2;return new TokenApi().checkTxEvent({txHash:txHash,eventName:eventName});case 2:res=_context.sent;if(!(res!==null&&res!==void 0&&res.status)){_context.next=6;break;}if(!(res!==null&&res!==void 0&&res.data)){_context.next=6;break;}return _context.abrupt(\"return\",true);case 6:case\"end\":return _context.stop();}},_callee);}));return function checkTxEventSingle(_x,_x2){return _ref.apply(this,arguments);};}();// FIXME: refactor function name and function code\nfunction getcheckTxEvent(_x3,_x4){return _getcheckTxEvent.apply(this,arguments);}function _getcheckTxEvent(){_getcheckTxEvent=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee3(txHash,eventName){return _regeneratorRuntime().wrap(function _callee3$(_context3){while(1)switch(_context3.prev=_context3.next){case 0:return _context3.abrupt(\"return\",new Promise(/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee2(resolve,reject){var temp,count;return _regeneratorRuntime().wrap(function _callee2$(_context2){while(1)switch(_context2.prev=_context2.next){case 0:temp=undefined,count=0;case 1:if(!(temp===undefined)){_context2.next=14;break;}count++;if(!(count>7)){_context2.next=5;break;}return _context2.abrupt(\"break\",14);case 5:_context2.next=7;return checkTxEventSingle(txHash,eventName);case 7:temp=_context2.sent;if(!(temp===true)){_context2.next=10;break;}return _context2.abrupt(\"break\",14);case 10:_context2.next=12;return sleep(1);case 12:_context2.next=1;break;case 14:resolve(true);case 15:case\"end\":return _context2.stop();}},_callee2);}));return function(_x5,_x6){return _ref2.apply(this,arguments);};}()));case 1:case\"end\":return _context3.stop();}},_callee3);}));return _getcheckTxEvent.apply(this,arguments);}var getTokenHistory=function getTokenHistory(contractAddress,tokenID){return new EventApi().getTokenHistory(contractAddress,tokenID).then(function(res){return res!==null&&res!==void 0&&res.status?res===null||res===void 0?void 0:res.data:null;});};return{getTierUpdatedToken:getTierUpdatedToken,createToken:createToken,getTokenList:getTokenList,checkToken:checkToken,getTokenHistory:getTokenHistory,updateUserTokenList:updateUserTokenList,getcheckTxEvent:getcheckTxEvent,getComputeTier:getComputeTier};}","map":{"version":3,"names":["TokenApi","EventApi","nowUnix","sleep","useHandleToken","createToken","data","_tierDuration","tier","computeTier","nfkey","updatedTime","tierUpdatedTime","i","tierTresr","getComputeTier","selectedToken","concat","_toConsumableArray","getTierUpdatedToken","_token","token","_objectSpread","currentTime","tierExpireTime","getTokenList","userAddress","then","res","_res$data","status","map","checkToken","tokenID","updateUserTokenList","contractAddress","count","arguments","length","undefined","catch","checkTxEventSingle","_ref","_asyncToGenerator","_regeneratorRuntime","mark","_callee","txHash","eventName","wrap","_callee$","_context","prev","next","checkTxEvent","sent","abrupt","stop","_x","_x2","apply","getcheckTxEvent","_x3","_x4","_getcheckTxEvent","_callee3","_callee3$","_context3","Promise","_ref2","_callee2","resolve","reject","temp","_callee2$","_context2","_x5","_x6","getTokenHistory"],"sources":["/Users/apple/Documents/treasure/src/hooks/token/useHandleToken.js"],"sourcesContent":["import TokenApi from \"../../api/TokenApi\";\nimport EventApi from \"../../api/EventApi\";\nimport { nowUnix, sleep } from \"../../utils\";\n// TODO: this is not required, should moved to useHandleNFT\nexport default function useHandleToken() {\n  const createToken = (data) => {\n    return new TokenApi().createToken(data);\n  };\n  const _tierDuration = (tier) => {\n    return (8 - tier) * 60; // PRODUCTION: this should be a day not 60s\n  };\n\n  const computeTier = (nfkey) => {\n    let updatedTime = nfkey?.tierUpdatedTime;\n    for (let i = nfkey?.tierTresr; i > 0; i--) {\n      if (nowUnix() < updatedTime + _tierDuration(i)) {\n        return i;\n      }\n      updatedTime += _tierDuration(i);\n    }\n    return 0;\n  };\n\n  // TODO: this should be refactored, computeTier, getComputeTier two function\n  const getComputeTier = (selectedToken) => {\n    const tierTresr = computeTier(selectedToken);\n    return [...selectedToken, tierTresr];\n  };\n\n  const getTierUpdatedToken = (_token) => {\n    let token = { ..._token };\n    let updatedTime = _token?.tierUpdatedTime;\n    let currentTime = nowUnix();\n    let i = 0;\n    for (i = token?.tierTresr; i > 0; i--) {\n      if (currentTime < updatedTime + _tierDuration(i)) {\n        updatedTime += _tierDuration(i);\n        break;\n      }\n      updatedTime += _tierDuration(i);\n    }\n    token.tierTresr = i;\n    token.tierExpireTime = updatedTime;\n    return token;\n  };\n\n  const getTokenList = (userAddress) => {\n    return new TokenApi().getTokenList(userAddress).then((res) =>\n      res?.status\n        ? res?.data?.data.map((nfkey) => {\n            nfkey = getTierUpdatedToken(nfkey);\n            return nfkey;\n          }) || []\n        : []\n    );\n  };\n\n  const checkToken = (tokenID) => {\n    return new TokenApi()\n      .checkToken({ tokenID })\n      .then((res) => (res?.status ? getTierUpdatedToken(res?.data) : null));\n  };\n\n  const updateUserTokenList = (contractAddress, count = 3) => {\n    return new TokenApi()\n      .updateUserTokenList({ contractAddress })\n      .then((res) => (res?.status ? res?.data : null))\n      .catch(() =>\n        count ? updateUserTokenList(contractAddress, count - 1) : null\n      );\n  };\n\n  const checkTxEventSingle = async (txHash, eventName) => {\n    const res = await new TokenApi().checkTxEvent({ txHash, eventName });\n    if (res?.status) if (res?.data) return true;\n  };\n  // FIXME: refactor function name and function code\n  async function getcheckTxEvent(txHash, eventName) {\n    return new Promise(async (resolve, reject) => {\n      let temp = undefined,\n        count = 0;\n      while (temp === undefined) {\n        count++;\n        if (count > 7) break;\n        temp = await checkTxEventSingle(txHash, eventName);\n        if (temp === true) break;\n        await sleep(1);\n      }\n      resolve(true);\n    });\n  }\n\n  const getTokenHistory = (contractAddress, tokenID) => {\n    return new EventApi()\n      .getTokenHistory(contractAddress, tokenID)\n      .then((res) => (res?.status ? res?.data : null));\n  };\n\n  return {\n    getTierUpdatedToken,\n    createToken,\n    getTokenList,\n    checkToken,\n    getTokenHistory,\n    updateUserTokenList,\n    getcheckTxEvent,\n    getComputeTier,\n  };\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}