{"ast":null,"code":"import _regeneratorRuntime from \"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";\nimport _asyncToGenerator from \"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport _inherits from \"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/inherits.js\";\nimport _createSuper from \"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/createSuper.js\";\nimport _classCallCheck from \"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";\nimport _createClass from \"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/createClass.js\";\nimport { Key } from 'interface-datastore/key';\n// @ts-expect-error readme is unused\n// eslint-disable-next-line no-unused-vars\nimport readme from './shard-readme.js';\n\n/**\n * @typedef {import('interface-datastore').Datastore} Datastore\n * @typedef {import('./types').Shard} Shard\n */\n\nexport var PREFIX = '/repo/flatfs/shard/';\nexport var SHARDING_FN = 'SHARDING';\nexport var README_FN = '_README';\n\n/**\n * @implements {Shard}\n */\nexport var ShardBase = /*#__PURE__*/function () {\n  /**\n   * @param {any} param\n   */\n  function ShardBase(param) {\n    _classCallCheck(this, ShardBase);\n    this.param = param;\n    this.name = 'base';\n    this._padding = '';\n  }\n\n  /**\n   * @param {string} s\n   */\n  _createClass(ShardBase, [{\n    key: \"fun\",\n    value: function fun(s) {\n      return 'implement me';\n    }\n  }, {\n    key: \"toString\",\n    value: function toString() {\n      return \"\".concat(PREFIX, \"v1/\").concat(this.name, \"/\").concat(this.param);\n    }\n  }]);\n  return ShardBase;\n}();\n/**\n * @implements {Shard}\n */\nexport var Prefix = /*#__PURE__*/function (_ShardBase) {\n  _inherits(Prefix, _ShardBase);\n  var _super = _createSuper(Prefix);\n  /**\n   * @param {number} prefixLen\n   */\n  function Prefix(prefixLen) {\n    var _this;\n    _classCallCheck(this, Prefix);\n    _this = _super.call(this, prefixLen);\n    _this._padding = ''.padStart(prefixLen, '_');\n    _this.name = 'prefix';\n    return _this;\n  }\n\n  /**\n   * @param {string} noslash\n   */\n  _createClass(Prefix, [{\n    key: \"fun\",\n    value: function fun(noslash) {\n      return (noslash + this._padding).slice(0, this.param);\n    }\n  }]);\n  return Prefix;\n}(ShardBase);\nexport var Suffix = /*#__PURE__*/function (_ShardBase2) {\n  _inherits(Suffix, _ShardBase2);\n  var _super2 = _createSuper(Suffix);\n  /**\n   * @param {number} suffixLen\n   */\n  function Suffix(suffixLen) {\n    var _this2;\n    _classCallCheck(this, Suffix);\n    _this2 = _super2.call(this, suffixLen);\n    _this2._padding = ''.padStart(suffixLen, '_');\n    _this2.name = 'suffix';\n    return _this2;\n  }\n\n  /**\n   * @param {string} noslash\n   */\n  _createClass(Suffix, [{\n    key: \"fun\",\n    value: function fun(noslash) {\n      var s = this._padding + noslash;\n      return s.slice(s.length - this.param);\n    }\n  }]);\n  return Suffix;\n}(ShardBase);\nexport var NextToLast = /*#__PURE__*/function (_ShardBase3) {\n  _inherits(NextToLast, _ShardBase3);\n  var _super3 = _createSuper(NextToLast);\n  /**\n   * @param {number} suffixLen\n   */\n  function NextToLast(suffixLen) {\n    var _this3;\n    _classCallCheck(this, NextToLast);\n    _this3 = _super3.call(this, suffixLen);\n    _this3._padding = ''.padStart(suffixLen + 1, '_');\n    _this3.name = 'next-to-last';\n    return _this3;\n  }\n\n  /**\n   * @param {string} noslash\n   */\n  _createClass(NextToLast, [{\n    key: \"fun\",\n    value: function fun(noslash) {\n      var s = this._padding + noslash;\n      var offset = s.length - this.param - 1;\n      return s.slice(offset, offset + this.param);\n    }\n  }]);\n  return NextToLast;\n}(ShardBase);\n\n/**\n * Convert a given string to the matching sharding function.\n *\n * @param {string} str\n * @returns {Shard}\n */\nexport function parseShardFun(str) {\n  str = str.trim();\n  if (str.length === 0) {\n    throw new Error('empty shard string');\n  }\n  if (!str.startsWith(PREFIX)) {\n    throw new Error(\"invalid or no path prefix: \".concat(str));\n  }\n  var parts = str.slice(PREFIX.length).split('/');\n  var version = parts[0];\n  if (version !== 'v1') {\n    throw new Error(\"expect 'v1' version, got '\".concat(version, \"'\"));\n  }\n  var name = parts[1];\n  if (!parts[2]) {\n    throw new Error('missing param');\n  }\n  var param = parseInt(parts[2], 10);\n  switch (name) {\n    case 'prefix':\n      return new Prefix(param);\n    case 'suffix':\n      return new Suffix(param);\n    case 'next-to-last':\n      return new NextToLast(param);\n    default:\n      throw new Error(\"unkown sharding function: \".concat(name));\n  }\n}\n\n/**\n * @param {string | Uint8Array} path\n * @param {Datastore} store\n */\nexport var readShardFun = /*#__PURE__*/function () {\n  var _ref = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee(path, store) {\n    var key, get, res;\n    return _regeneratorRuntime().wrap(function _callee$(_context) {\n      while (1) switch (_context.prev = _context.next) {\n        case 0:\n          key = new Key(path).child(new Key(SHARDING_FN)); // @ts-ignore\n          get = typeof store.getRaw === 'function' ? store.getRaw.bind(store) : store.get.bind(store);\n          _context.next = 4;\n          return get(key);\n        case 4:\n          res = _context.sent;\n          return _context.abrupt(\"return\", parseShardFun(new TextDecoder().decode(res || '').trim()));\n        case 6:\n        case \"end\":\n          return _context.stop();\n      }\n    }, _callee);\n  }));\n  return function readShardFun(_x, _x2) {\n    return _ref.apply(this, arguments);\n  };\n}();\nexport { default as readme } from './shard-readme.js';","map":{"version":3,"names":["Key","readme","PREFIX","SHARDING_FN","README_FN","ShardBase","param","_classCallCheck","name","_padding","_createClass","key","value","fun","s","toString","concat","Prefix","_ShardBase","_inherits","_super","_createSuper","prefixLen","_this","call","padStart","noslash","slice","Suffix","_ShardBase2","_super2","suffixLen","_this2","length","NextToLast","_ShardBase3","_super3","_this3","offset","parseShardFun","str","trim","Error","startsWith","parts","split","version","parseInt","readShardFun","_ref","_asyncToGenerator","_regeneratorRuntime","mark","_callee","path","store","get","res","wrap","_callee$","_context","prev","next","child","getRaw","bind","sent","abrupt","TextDecoder","decode","stop","_x","_x2","apply","arguments","default"],"sources":["/Users/apple/Documents/treasure/node_modules/datastore-core/src/shard.js"],"sourcesContent":["import { Key } from 'interface-datastore/key'\n// @ts-expect-error readme is unused\n// eslint-disable-next-line no-unused-vars\nimport readme from './shard-readme.js'\n\n/**\n * @typedef {import('interface-datastore').Datastore} Datastore\n * @typedef {import('./types').Shard} Shard\n */\n\nexport const PREFIX = '/repo/flatfs/shard/'\nexport const SHARDING_FN = 'SHARDING'\nexport const README_FN = '_README'\n\n/**\n * @implements {Shard}\n */\nexport class ShardBase {\n  /**\n   * @param {any} param\n   */\n  constructor (param) {\n    this.param = param\n    this.name = 'base'\n    this._padding = ''\n  }\n\n  /**\n   * @param {string} s\n   */\n  fun (s) {\n    return 'implement me'\n  }\n\n  toString () {\n    return `${PREFIX}v1/${this.name}/${this.param}`\n  }\n}\n/**\n * @implements {Shard}\n */\nexport class Prefix extends ShardBase {\n  /**\n   * @param {number} prefixLen\n   */\n  constructor (prefixLen) {\n    super(prefixLen)\n    this._padding = ''.padStart(prefixLen, '_')\n    this.name = 'prefix'\n  }\n\n  /**\n   * @param {string} noslash\n   */\n  fun (noslash) {\n    return (noslash + this._padding).slice(0, this.param)\n  }\n}\n\nexport class Suffix extends ShardBase {\n  /**\n   * @param {number} suffixLen\n   */\n  constructor (suffixLen) {\n    super(suffixLen)\n    this._padding = ''.padStart(suffixLen, '_')\n    this.name = 'suffix'\n  }\n\n  /**\n   * @param {string} noslash\n   */\n  fun (noslash) {\n    const s = this._padding + noslash\n    return s.slice(s.length - this.param)\n  }\n}\n\nexport class NextToLast extends ShardBase {\n  /**\n   * @param {number} suffixLen\n   */\n  constructor (suffixLen) {\n    super(suffixLen)\n    this._padding = ''.padStart(suffixLen + 1, '_')\n    this.name = 'next-to-last'\n  }\n\n  /**\n   * @param {string} noslash\n   */\n  fun (noslash) {\n    const s = this._padding + noslash\n    const offset = s.length - this.param - 1\n    return s.slice(offset, offset + this.param)\n  }\n}\n\n/**\n * Convert a given string to the matching sharding function.\n *\n * @param {string} str\n * @returns {Shard}\n */\nexport function parseShardFun (str) {\n  str = str.trim()\n\n  if (str.length === 0) {\n    throw new Error('empty shard string')\n  }\n\n  if (!str.startsWith(PREFIX)) {\n    throw new Error(`invalid or no path prefix: ${str}`)\n  }\n\n  const parts = str.slice(PREFIX.length).split('/')\n  const version = parts[0]\n\n  if (version !== 'v1') {\n    throw new Error(`expect 'v1' version, got '${version}'`)\n  }\n\n  const name = parts[1]\n\n  if (!parts[2]) {\n    throw new Error('missing param')\n  }\n\n  const param = parseInt(parts[2], 10)\n\n  switch (name) {\n    case 'prefix':\n      return new Prefix(param)\n    case 'suffix':\n      return new Suffix(param)\n    case 'next-to-last':\n      return new NextToLast(param)\n    default:\n      throw new Error(`unkown sharding function: ${name}`)\n  }\n}\n\n/**\n * @param {string | Uint8Array} path\n * @param {Datastore} store\n */\nexport const readShardFun = async (path, store) => {\n  const key = new Key(path).child(new Key(SHARDING_FN))\n  // @ts-ignore\n  const get = typeof store.getRaw === 'function' ? store.getRaw.bind(store) : store.get.bind(store)\n  const res = await get(key)\n  return parseShardFun(new TextDecoder().decode(res || '').trim())\n}\n\nexport { default as readme } from './shard-readme.js'\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}