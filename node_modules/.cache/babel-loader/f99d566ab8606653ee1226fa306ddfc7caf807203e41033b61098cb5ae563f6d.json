{"ast":null,"code":"var _classCallCheck = require(\"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/classCallCheck.js\").default;\nvar _createClass = require(\"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/createClass.js\").default;\nvar _inherits = require(\"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/inherits.js\").default;\nvar _createSuper = require(\"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/createSuper.js\").default;\nvar RateLimiterAbstract = require('./RateLimiterAbstract');\nvar MemoryStorage = require('./component/MemoryStorage/MemoryStorage');\nvar RateLimiterRes = require('./RateLimiterRes');\nvar RateLimiterMemory = /*#__PURE__*/function (_RateLimiterAbstract) {\n  \"use strict\";\n\n  _inherits(RateLimiterMemory, _RateLimiterAbstract);\n  var _super = _createSuper(RateLimiterMemory);\n  function RateLimiterMemory() {\n    var _this;\n    var opts = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n    _classCallCheck(this, RateLimiterMemory);\n    _this = _super.call(this, opts);\n    _this._memoryStorage = new MemoryStorage();\n    return _this;\n  }\n  /**\n   *\n   * @param key\n   * @param pointsToConsume\n   * @param {Object} options\n   * @returns {Promise<RateLimiterRes>}\n   */\n  _createClass(RateLimiterMemory, [{\n    key: \"consume\",\n    value: function consume(key) {\n      var _this2 = this;\n      var pointsToConsume = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 1;\n      var options = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};\n      return new Promise(function (resolve, reject) {\n        var rlKey = _this2.getKey(key);\n        var secDuration = _this2._getKeySecDuration(options);\n        var res = _this2._memoryStorage.incrby(rlKey, pointsToConsume, secDuration);\n        res.remainingPoints = Math.max(_this2.points - res.consumedPoints, 0);\n        if (res.consumedPoints > _this2.points) {\n          // Block only first time when consumed more than points\n          if (_this2.blockDuration > 0 && res.consumedPoints <= _this2.points + pointsToConsume) {\n            // Block key\n            res = _this2._memoryStorage.set(rlKey, res.consumedPoints, _this2.blockDuration);\n          }\n          reject(res);\n        } else if (_this2.execEvenly && res.msBeforeNext > 0 && !res.isFirstInDuration) {\n          // Execute evenly\n          var delay = Math.ceil(res.msBeforeNext / (res.remainingPoints + 2));\n          if (delay < _this2.execEvenlyMinDelayMs) {\n            delay = res.consumedPoints * _this2.execEvenlyMinDelayMs;\n          }\n          setTimeout(resolve, delay, res);\n        } else {\n          resolve(res);\n        }\n      });\n    }\n  }, {\n    key: \"penalty\",\n    value: function penalty(key) {\n      var _this3 = this;\n      var points = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 1;\n      var options = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};\n      var rlKey = this.getKey(key);\n      return new Promise(function (resolve) {\n        var secDuration = _this3._getKeySecDuration(options);\n        var res = _this3._memoryStorage.incrby(rlKey, points, secDuration);\n        res.remainingPoints = Math.max(_this3.points - res.consumedPoints, 0);\n        resolve(res);\n      });\n    }\n  }, {\n    key: \"reward\",\n    value: function reward(key) {\n      var _this4 = this;\n      var points = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 1;\n      var options = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};\n      var rlKey = this.getKey(key);\n      return new Promise(function (resolve) {\n        var secDuration = _this4._getKeySecDuration(options);\n        var res = _this4._memoryStorage.incrby(rlKey, -points, secDuration);\n        res.remainingPoints = Math.max(_this4.points - res.consumedPoints, 0);\n        resolve(res);\n      });\n    }\n\n    /**\n     * Block any key for secDuration seconds\n     *\n     * @param key\n     * @param secDuration\n     */\n  }, {\n    key: \"block\",\n    value: function block(key, secDuration) {\n      var msDuration = secDuration * 1000;\n      var initPoints = this.points + 1;\n      this._memoryStorage.set(this.getKey(key), initPoints, secDuration);\n      return Promise.resolve(new RateLimiterRes(0, msDuration === 0 ? -1 : msDuration, initPoints));\n    }\n  }, {\n    key: \"set\",\n    value: function set(key, points, secDuration) {\n      var msDuration = (secDuration >= 0 ? secDuration : this.duration) * 1000;\n      this._memoryStorage.set(this.getKey(key), points, secDuration);\n      return Promise.resolve(new RateLimiterRes(0, msDuration === 0 ? -1 : msDuration, points));\n    }\n  }, {\n    key: \"get\",\n    value: function get(key) {\n      var res = this._memoryStorage.get(this.getKey(key));\n      if (res !== null) {\n        res.remainingPoints = Math.max(this.points - res.consumedPoints, 0);\n      }\n      return Promise.resolve(res);\n    }\n  }, {\n    key: \"delete\",\n    value: function _delete(key) {\n      return Promise.resolve(this._memoryStorage.delete(this.getKey(key)));\n    }\n  }]);\n  return RateLimiterMemory;\n}(RateLimiterAbstract);\nmodule.exports = RateLimiterMemory;","map":{"version":3,"names":["RateLimiterAbstract","require","MemoryStorage","RateLimiterRes","RateLimiterMemory","_RateLimiterAbstract","_inherits","_super","_createSuper","_this","opts","arguments","length","undefined","_classCallCheck","call","_memoryStorage","_createClass","key","value","consume","_this2","pointsToConsume","options","Promise","resolve","reject","rlKey","getKey","secDuration","_getKeySecDuration","res","incrby","remainingPoints","Math","max","points","consumedPoints","blockDuration","set","execEvenly","msBeforeNext","isFirstInDuration","delay","ceil","execEvenlyMinDelayMs","setTimeout","penalty","_this3","reward","_this4","block","msDuration","initPoints","duration","get","_delete","delete","module","exports"],"sources":["/Users/apple/Documents/treasure/node_modules/rate-limiter-flexible/lib/RateLimiterMemory.js"],"sourcesContent":["const RateLimiterAbstract = require('./RateLimiterAbstract');\nconst MemoryStorage = require('./component/MemoryStorage/MemoryStorage');\nconst RateLimiterRes = require('./RateLimiterRes');\n\nclass RateLimiterMemory extends RateLimiterAbstract {\n  constructor(opts = {}) {\n    super(opts);\n\n    this._memoryStorage = new MemoryStorage();\n  }\n  /**\n   *\n   * @param key\n   * @param pointsToConsume\n   * @param {Object} options\n   * @returns {Promise<RateLimiterRes>}\n   */\n  consume(key, pointsToConsume = 1, options = {}) {\n    return new Promise((resolve, reject) => {\n      const rlKey = this.getKey(key);\n      const secDuration = this._getKeySecDuration(options);\n      let res = this._memoryStorage.incrby(rlKey, pointsToConsume, secDuration);\n      res.remainingPoints = Math.max(this.points - res.consumedPoints, 0);\n\n      if (res.consumedPoints > this.points) {\n        // Block only first time when consumed more than points\n        if (this.blockDuration > 0 && res.consumedPoints <= (this.points + pointsToConsume)) {\n          // Block key\n          res = this._memoryStorage.set(rlKey, res.consumedPoints, this.blockDuration);\n        }\n        reject(res);\n      } else if (this.execEvenly && res.msBeforeNext > 0 && !res.isFirstInDuration) {\n        // Execute evenly\n        let delay = Math.ceil(res.msBeforeNext / (res.remainingPoints + 2));\n        if (delay < this.execEvenlyMinDelayMs) {\n          delay = res.consumedPoints * this.execEvenlyMinDelayMs;\n        }\n\n        setTimeout(resolve, delay, res);\n      } else {\n        resolve(res);\n      }\n    });\n  }\n\n  penalty(key, points = 1, options = {}) {\n    const rlKey = this.getKey(key);\n    return new Promise((resolve) => {\n      const secDuration = this._getKeySecDuration(options);\n      const res = this._memoryStorage.incrby(rlKey, points, secDuration);\n      res.remainingPoints = Math.max(this.points - res.consumedPoints, 0);\n      resolve(res);\n    });\n  }\n\n  reward(key, points = 1, options = {}) {\n    const rlKey = this.getKey(key);\n    return new Promise((resolve) => {\n      const secDuration = this._getKeySecDuration(options);\n      const res = this._memoryStorage.incrby(rlKey, -points, secDuration);\n      res.remainingPoints = Math.max(this.points - res.consumedPoints, 0);\n      resolve(res);\n    });\n  }\n\n  /**\n   * Block any key for secDuration seconds\n   *\n   * @param key\n   * @param secDuration\n   */\n  block(key, secDuration) {\n    const msDuration = secDuration * 1000;\n    const initPoints = this.points + 1;\n\n    this._memoryStorage.set(this.getKey(key), initPoints, secDuration);\n    return Promise.resolve(\n      new RateLimiterRes(0, msDuration === 0 ? -1 : msDuration, initPoints)\n    );\n  }\n\n  set(key, points, secDuration) {\n    const msDuration = (secDuration >= 0 ? secDuration : this.duration) * 1000;\n\n    this._memoryStorage.set(this.getKey(key), points, secDuration);\n    return Promise.resolve(\n      new RateLimiterRes(0, msDuration === 0 ? -1 : msDuration, points)\n    );\n  }\n\n  get(key) {\n    const res = this._memoryStorage.get(this.getKey(key));\n    if (res !== null) {\n      res.remainingPoints = Math.max(this.points - res.consumedPoints, 0);\n    }\n\n    return Promise.resolve(res);\n  }\n\n  delete(key) {\n    return Promise.resolve(this._memoryStorage.delete(this.getKey(key)));\n  }\n}\n\nmodule.exports = RateLimiterMemory;\n\n"],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}