{"ast":null,"code":"import _regeneratorRuntime from \"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";\nimport _asyncToGenerator from \"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport _asyncIterator from \"/Users/apple/Documents/treasure/node_modules/@babel/runtime/helpers/esm/asyncIterator.js\";\nimport ready from './ready.js';\nexport default (function (socket, options) {\n  var _options;\n  options = (_options = options) !== null && _options !== void 0 ? _options : {};\n  options.closeOnEnd = options.closeOnEnd !== false;\n  var sink = /*#__PURE__*/function () {\n    var _ref = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee(source) {\n      var _iteratorAbruptCompletion, _didIteratorError, _iteratorError, _iterator, _step, data;\n      return _regeneratorRuntime().wrap(function _callee$(_context) {\n        while (1) switch (_context.prev = _context.next) {\n          case 0:\n            _iteratorAbruptCompletion = false;\n            _didIteratorError = false;\n            _context.prev = 2;\n            _iterator = _asyncIterator(source);\n          case 4:\n            _context.next = 6;\n            return _iterator.next();\n          case 6:\n            if (!(_iteratorAbruptCompletion = !(_step = _context.sent).done)) {\n              _context.next = 22;\n              break;\n            }\n            data = _step.value;\n            _context.prev = 8;\n            _context.next = 11;\n            return ready(socket);\n          case 11:\n            _context.next = 18;\n            break;\n          case 13:\n            _context.prev = 13;\n            _context.t0 = _context[\"catch\"](8);\n            if (!(_context.t0.message === 'socket closed')) {\n              _context.next = 17;\n              break;\n            }\n            return _context.abrupt(\"break\", 22);\n          case 17:\n            throw _context.t0;\n          case 18:\n            socket.send(data);\n          case 19:\n            _iteratorAbruptCompletion = false;\n            _context.next = 4;\n            break;\n          case 22:\n            _context.next = 28;\n            break;\n          case 24:\n            _context.prev = 24;\n            _context.t1 = _context[\"catch\"](2);\n            _didIteratorError = true;\n            _iteratorError = _context.t1;\n          case 28:\n            _context.prev = 28;\n            _context.prev = 29;\n            if (!(_iteratorAbruptCompletion && _iterator.return != null)) {\n              _context.next = 33;\n              break;\n            }\n            _context.next = 33;\n            return _iterator.return();\n          case 33:\n            _context.prev = 33;\n            if (!_didIteratorError) {\n              _context.next = 36;\n              break;\n            }\n            throw _iteratorError;\n          case 36:\n            return _context.finish(33);\n          case 37:\n            return _context.finish(28);\n          case 38:\n            if (!(options.closeOnEnd != null && socket.readyState <= 1)) {\n              _context.next = 42;\n              break;\n            }\n            _context.next = 41;\n            return new Promise(function (resolve, reject) {\n              socket.addEventListener('close', function (event) {\n                if (event.wasClean || event.code === 1006) {\n                  resolve();\n                } else {\n                  var err = Object.assign(new Error('ws error'), {\n                    event: event\n                  });\n                  reject(err);\n                }\n              });\n              setTimeout(function () {\n                return socket.close();\n              });\n            });\n          case 41:\n            return _context.abrupt(\"return\", _context.sent);\n          case 42:\n          case \"end\":\n            return _context.stop();\n        }\n      }, _callee, null, [[2, 24, 28, 38], [8, 13], [29,, 33, 37]]);\n    }));\n    return function sink(_x) {\n      return _ref.apply(this, arguments);\n    };\n  }();\n  return sink;\n});","map":{"version":3,"names":["ready","socket","options","_options","closeOnEnd","sink","_ref","_asyncToGenerator","_regeneratorRuntime","mark","_callee","source","_iteratorAbruptCompletion","_didIteratorError","_iteratorError","_iterator","_step","data","wrap","_callee$","_context","prev","next","_asyncIterator","sent","done","value","t0","message","abrupt","send","t1","return","finish","readyState","Promise","resolve","reject","addEventListener","event","wasClean","code","err","Object","assign","Error","setTimeout","close","stop","_x","apply","arguments"],"sources":["/Users/apple/Documents/treasure/node_modules/it-ws/src/sink.ts"],"sourcesContent":["import ready from './ready.js'\nimport type { WebSocket } from 'ws'\nimport type { Sink } from 'it-stream-types'\n\nexport interface SinkOptions {\n  closeOnEnd?: boolean\n}\n\nexport default (socket: WebSocket, options: SinkOptions) => {\n  options = options ?? {}\n  options.closeOnEnd = options.closeOnEnd !== false\n\n  const sink: Sink<Uint8Array, Promise<void>> = async source => {\n    for await (const data of source) {\n      try {\n        await ready(socket)\n      } catch (err: any) {\n        if (err.message === 'socket closed') break\n        throw err\n      }\n\n      socket.send(data)\n    }\n\n    if (options.closeOnEnd != null && socket.readyState <= 1) {\n      return await new Promise((resolve, reject) => {\n        socket.addEventListener('close', event => {\n          if (event.wasClean || event.code === 1006) {\n            resolve()\n          } else {\n            const err = Object.assign(new Error('ws error'), { event })\n            reject(err)\n          }\n        })\n\n        setTimeout(() => socket.close())\n      })\n    }\n  }\n\n  return sink\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}